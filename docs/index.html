<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#0a0a0a" />
    <title>The Burnay Lab</title>
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='-2 -2 100 114' fill='none'%3E%3Cpath d='M10,6 L48,6 L58,16 L58,38 L48,48 L58,58 L58,84 L48,96 L10,96 Z' stroke='%23fafafa' stroke-width='2.5' fill='none' stroke-linejoin='miter'/%3E%3Cline x1='10' y1='48' x2='48' y2='48' stroke='%23fafafa' stroke-width='2.5'/%3E%3Cpolyline points='70,4 70,70 48,96 92,96' stroke='%23fafafa' stroke-width='2.5' fill='none' stroke-linejoin='miter'/%3E%3C/svg%3E"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script>
      // Early theme restore to prevent flash
      (function () {
        var t = localStorage.getItem("bl_theme");
        if (
          t === "light" ||
          (!t &&
            window.matchMedia &&
            window.matchMedia("(prefers-color-scheme: light)").matches)
        )
          document.documentElement.setAttribute("data-theme", "light");
      })();
    </script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html {
        background: var(--bg-primary);
      }
      :root {
        --bg-primary: #0a0a0a;
        --bg-secondary: #141414;
        --bg-tertiary: #1a1a1a;
        --bg-elevated: #1e1e1e;
        --bg-active: #3a3a3a;
        --border: rgba(255, 255, 255, 0.06);
        --border-hover: rgba(255, 255, 255, 0.12);
        --text-primary: #fafafa;
        --text-secondary: #a1a1a1;
        --text-muted: #666;
        --accent: #e5e5e5;
        --accent-hover: #fff;
        --green: #22c55e;
        --yellow: #eab308;
        --red: #ef4444;
        --radius: 8px;
        --radius-lg: 12px;
        --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        --shadow-section: 0 2px 8px rgba(0, 0, 0, 0.3), 0 0 1px rgba(255, 255, 255, 0.05);
        --shadow-card: 0 1px 4px rgba(0, 0, 0, 0.25), 0 0 1px rgba(255, 255, 255, 0.04);
      }
      [data-theme="light"] {
        --bg-primary: #0a0a0a;
        --bg-secondary: #ffffff;
        --bg-tertiary: #f5f5f7;
        --bg-elevated: #e8e8ed;
        --bg-active: #000000;
        --border: rgba(0, 0, 0, 0.08);
        --border-hover: rgba(0, 0, 0, 0.15);
        --text-primary: #1d1d1f;
        --text-secondary: #6e6e73;
        --text-muted: #8e8e93;
        --accent: #1d1d1f;
        --accent-hover: #000;
        --green: #34c759;
        --yellow: #ff9f0a;
        --red: #ff3b30;
        --shadow-section: 0 2px 12px rgba(0, 0, 0, 0.3), 0 0 1px rgba(255, 255, 255, 0.08);
        --shadow-card: 0 1px 6px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(0, 0, 0, 0.04);
      }
      [data-theme="light"] .logo-icon svg path,
      [data-theme="light"] .logo-icon svg line,
      [data-theme="light"] .logo-icon svg polyline {
        stroke: #1d1d1f;
      }
      [data-theme="light"] .logo-small svg path,
      [data-theme="light"] .logo-small svg line,
      [data-theme="light"] .logo-small svg polyline {
        stroke: #fafafa;
      }
      [data-theme="light"] .loading-overlay {
        background: #000;
      }
      [data-theme="light"] .nav-tab.active {
        animation-name: borderGlowLight;
        color: #fafafa;
      }
      [data-theme="light"] .student-item.active {
        animation-name: borderGlowLight;
        color: #fafafa;
      }
      [data-theme="light"] .student-item.active .student-info .name,
      [data-theme="light"] .student-item.active .student-info .meta {
        color: #fafafa;
      }
      [data-theme="light"] .main-header {
        color: #fafafa;
      }
      [data-theme="light"] .main-header h1,
      [data-theme="light"] .main-header .header-right span,
      [data-theme="light"] .main-header .btn-icon {
        color: #fafafa;
      }
      [data-theme="light"] .main-header .role-badge {
        color: #a1a1a1;
        border-color: rgba(255, 255, 255, 0.06);
        background: rgba(255, 255, 255, 0.06);
      }
      [data-theme="light"] #theme-toggle {
        color: #fafafa;
      }
      [data-theme="light"] .student-item.active .student-avatar {
        background: #ffffff;
        color: #000000;
      }
      /* Login screen stays dark in light mode — override text colors to stay light */
      [data-theme="light"] #login-screen {
        color: #fafafa;
      }
      [data-theme="light"] .login-header h1 {
        color: #fafafa;
      }
      [data-theme="light"] .subtitle {
        color: #a1a1a1;
      }
      [data-theme="light"] #login-screen .form-group input {
        color: #fafafa;
        caret-color: #fafafa;
        border-bottom-color: rgba(255, 255, 255, 0.12);
      }
      [data-theme="light"] #login-screen .form-group input:focus {
        border-bottom-color: #fafafa;
        box-shadow: 0 1px 0 0 #fafafa;
      }
      [data-theme="light"] #login-screen .form-group input::placeholder {
        color: #8e8e93;
      }
      [data-theme="light"] #login-screen .form-group label {
        color: #a1a1a1;
      }
      [data-theme="light"] #login-screen .btn {
        color: #fafafa;
        border-color: rgba(255, 255, 255, 0.12);
      }
      [data-theme="light"] #login-screen .btn:hover {
        background: #fafafa;
        color: #0a0a0a;
        border-color: #fafafa;
      }
      [data-theme="light"] #login-screen .by-line {
        color: #8e8e93;
        border-top-color: rgba(255, 255, 255, 0.08);
      }
      [data-theme="light"] #login-screen .by-line a {
        color: #a1a1a1;
        border-bottom-color: rgba(255, 255, 255, 0.12);
      }
      [data-theme="light"] #login-screen .by-line a:hover {
        color: #fafafa;
      }
      /* Diagnostic overlay stays dark — keep light text */
      [data-theme="light"] .diag-overlay {
        color: #fafafa;
      }
      [data-theme="light"] .item-card {
        background: #f9f9fb;
      }
      @keyframes borderGlowLight {
        0% {
          box-shadow:
            0 0 8px rgba(0, 0, 0, 0.08),
            inset 2px 0 4px rgba(0, 0, 0, 0.1),
            inset 0 0 0 0.5px rgba(0, 0, 0, 0.08);
        }
        25% {
          box-shadow:
            0 0 8px rgba(0, 0, 0, 0.08),
            inset 0 2px 4px rgba(0, 0, 0, 0.1),
            inset 0 0 0 0.5px rgba(0, 0, 0, 0.08);
        }
        50% {
          box-shadow:
            0 0 8px rgba(0, 0, 0, 0.08),
            inset -2px 0 4px rgba(0, 0, 0, 0.1),
            inset 0 0 0 0.5px rgba(0, 0, 0, 0.08);
        }
        75% {
          box-shadow:
            0 0 8px rgba(0, 0, 0, 0.08),
            inset 0 -2px 4px rgba(0, 0, 0, 0.1),
            inset 0 0 0 0.5px rgba(0, 0, 0, 0.08);
        }
        100% {
          box-shadow:
            0 0 8px rgba(0, 0, 0, 0.08),
            inset 2px 0 4px rgba(0, 0, 0, 0.1),
            inset 0 0 0 0.5px rgba(0, 0, 0, 0.08);
        }
      }
      body {
        font-family:
          "Inter",
          system-ui,
          -apple-system,
          sans-serif;
        min-height: 100vh;
        background: var(--bg-primary);
        color: var(--text-primary);
        -webkit-font-smoothing: antialiased;
      }

      /* ===== LOGIN ===== */
      body.login-view {
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-primary);
      }
      body.dashboard-view {
        display: block;
      }
      #login-screen {
        width: 100%;
        max-width: 400px;
        padding: 48px 40px;
      }
      .login-header {
        text-align: center;
        margin-bottom: 28px;
      }
      .logo-icon {
        width: 72px;
        height: 72px;
        margin: 0 auto 28px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .logo-icon svg {
        width: 72px;
        height: 78px;
      }
      .login-header h1 {
        font-size: 22px;
        font-weight: 600;
        letter-spacing: -0.03em;
        margin-bottom: 4px;
      }
      .subtitle {
        color: var(--text-muted);
        font-size: 10px;
        font-weight: 400;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        margin-bottom: 0;
      }
      .by-line {
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
        font-size: 11px;
        color: var(--text-muted);
      }
      .by-line a {
        color: var(--text-secondary);
        text-decoration: none;
        border-bottom: 1px solid var(--border);
        transition: var(--transition);
      }
      .by-line a:hover {
        color: var(--text-primary);
        border-color: var(--text-secondary);
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 8px;
        color: var(--text-secondary);
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px 14px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        font-size: 14px;
        font-family: inherit;
        color: var(--text-primary);
        transition: var(--transition);
        outline: none;
      }
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        border-color: var(--border-hover);
        background: var(--bg-tertiary);
      }
      .form-group input::placeholder {
        color: var(--text-muted);
      }
      .btn {
        display: block;
        width: 100%;
        padding: 10px 20px;
        background: var(--text-primary);
        color: var(--bg-primary);
        border: none;
        border-radius: var(--radius);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        font-family: inherit;
        transition: var(--transition);
      }
      .btn:hover {
        opacity: 0.9;
      }
      .btn:active {
        transform: scale(0.97);
      }
      .error-message {
        margin-top: 16px;
        padding: 12px;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.2);
        border-radius: var(--radius);
        color: var(--red);
        font-size: 13px;
        text-align: center;
        display: none;
      }
      .error-message.show {
        display: block;
      }
      #login-screen .form-group {
        margin-bottom: 8px;
      }
      #login-screen .form-group input {
        border-radius: 0;
        background: transparent;
        border: none;
        border-bottom: 1px solid var(--border);
        padding: 10px 4px;
        font-size: 13px;
        letter-spacing: 0.02em;
        color: var(--text-primary);
        caret-color: var(--text-primary);
        transition: border-color 0.3s ease;
      }
      #login-screen .form-group input:focus {
        border-bottom-color: var(--text-primary);
        background: transparent;
        box-shadow: 0 1px 0 0 var(--text-primary);
      }
      #login-screen .form-group input::placeholder {
        color: var(--text-muted);
        font-weight: 300;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        font-size: 10px;
      }
      #login-screen .btn {
        border-radius: 6px;
        background: transparent;
        color: var(--text-primary);
        border: 1px solid var(--border);
        padding: 10px 20px;
        font-size: 10px;
        font-weight: 500;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        margin-top: 16px;
        transition: all 0.3s ease;
        position: relative;
      }
      #login-screen .btn:hover {
        background: var(--text-primary);
        color: var(--bg-primary);
        border-color: var(--text-primary);
        opacity: 1;
      }
      #login-screen .btn.loading {
        color: transparent;
        pointer-events: none;
      }
      #login-screen .btn.loading::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 14px;
        height: 14px;
        margin: -7px 0 0 -7px;
        border: 1.5px solid var(--text-muted);
        border-top-color: var(--text-primary);
        border-radius: 50%;
        animation: btnSpin 0.6s linear infinite;
      }
      @keyframes btnSpin {
        to {
          transform: rotate(360deg);
        }
      }
      .remember-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 12px;
      }
      .remember-row input[type="checkbox"] {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        width: 14px;
        height: 14px;
        border: 1px solid var(--border);
        border-radius: 3px;
        background: transparent;
        cursor: pointer;
        position: relative;
        transition: border-color 0.2s ease;
      }
      .remember-row input[type="checkbox"]:checked {
        border-color: var(--text-secondary);
      }
      .remember-row input[type="checkbox"]:checked::after {
        content: "";
        position: absolute;
        top: 1px;
        left: 4px;
        width: 4px;
        height: 8px;
        border: solid var(--text-primary);
        border-width: 0 1.5px 1.5px 0;
        transform: rotate(45deg);
      }
      .remember-row label {
        font-size: 11px;
        color: var(--text-muted);
        cursor: pointer;
        user-select: none;
      }
      .hidden {
        display: none !important;
      }

      /* ===== DASHBOARD ===== */
      #dashboard-screen {
        display: none;
        min-height: 100vh;
      }
      #dashboard-screen.active {
        display: block;
        animation: fadeIn 0.4s ease;
      }
      .main-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
        height: 56px;
        background: var(--bg-primary);
        border-bottom: none;
        box-shadow: none;
        animation: slideDown 0.35s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .header-left,
      .header-right {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .logo-small {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .logo-small svg {
        width: 24px;
        height: 24px;
        stroke: var(--text-primary);
        fill: none;
        stroke-width: 1.5;
      }
      .main-header h1 {
        font-size: 15px;
        font-weight: 600;
        letter-spacing: -0.01em;
      }
      .btn-icon {
        width: 36px;
        height: 36px;
        border: none;
        background: transparent;
        border-radius: var(--radius);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
      }
      .btn-icon:hover {
        background: var(--bg-tertiary);
        transform: scale(1.05);
      }
      .btn-icon:active {
        transform: scale(0.95);
      }
      .btn-icon:hover svg {
        fill: var(--text-primary);
      }
      .btn-icon svg {
        width: 18px;
        height: 18px;
        fill: var(--text-secondary);
        stroke: none;
        transition: fill 0.2s;
      }
      .role-badge {
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 20px;
        font-weight: 500;
        background: var(--bg-tertiary);
        color: var(--text-muted);
        border: 1px solid var(--border);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        transition: var(--transition);
      }
      .role-badge:hover {
        border-color: var(--border-hover);
        box-shadow: 0 0 8px rgba(255, 255, 255, 0.05);
      }
      .main-content {
        display: flex;
        min-height: calc(100vh - 56px);
        padding: 4px 8px 8px 8px;
        gap: 8px;
        background: var(--bg-primary);
      }

      /* ===== SIDEBAR ===== */
      .sidebar {
        width: 300px;
        background: var(--bg-secondary);
        border: none;
        border-radius: 12px;
        box-shadow: var(--shadow-section);
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        animation: fadeIn 0.4s ease 0.1s both;
      }
      .student-list {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .student-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 16px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: var(--transition);
      }
      .student-item:hover {
        background: var(--bg-tertiary);
        transform: translateX(4px);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
      }
      .student-item:active {
        transform: translateX(2px);
      }
      @keyframes borderGlow {
        0% {
          box-shadow:
            0 0 8px rgba(255, 255, 255, 0.15),
            inset 2px 0 4px rgba(255, 255, 255, 0.3),
            inset 0 0 0 0.5px rgba(255, 255, 255, 0.15);
        }
        25% {
          box-shadow:
            0 0 8px rgba(255, 255, 255, 0.15),
            inset 0 2px 4px rgba(255, 255, 255, 0.3),
            inset 0 0 0 0.5px rgba(255, 255, 255, 0.15);
        }
        50% {
          box-shadow:
            0 0 8px rgba(255, 255, 255, 0.15),
            inset -2px 0 4px rgba(255, 255, 255, 0.3),
            inset 0 0 0 0.5px rgba(255, 255, 255, 0.15);
        }
        75% {
          box-shadow:
            0 0 8px rgba(255, 255, 255, 0.15),
            inset 0 -2px 4px rgba(255, 255, 255, 0.3),
            inset 0 0 0 0.5px rgba(255, 255, 255, 0.15);
        }
        100% {
          box-shadow:
            0 0 8px rgba(255, 255, 255, 0.15),
            inset 2px 0 4px rgba(255, 255, 255, 0.3),
            inset 0 0 0 0.5px rgba(255, 255, 255, 0.15);
        }
      }
      .student-item.active {
        background: var(--bg-active);
        border: none;
        animation: borderGlow 3s ease-in-out infinite;
      }
      .student-avatar {
        width: 32px;
        height: 32px;
        background: var(--bg-tertiary);
        border: none;
        border-radius: 50%;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 13px;
        transition: var(--transition);
      }
      .student-item.active .student-avatar {
        background: var(--text-primary);
        color: var(--bg-primary);
        border-color: transparent;
      }
      .student-info {
        flex: 1;
        min-width: 0;
      }
      .student-info .name {
        font-weight: 600;
        font-size: 13px;
      }
      .student-info .meta {
        font-size: 12px;
        color: var(--text-muted);
      }
      .students-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 16px;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        border: none;
        outline: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        width: 100%;
        font-family: inherit;
        transition: var(--transition);
        box-shadow: var(--shadow-card);
      }
      .students-toggle:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }
      .students-toggle svg {
        width: 12px;
        height: 12px;
        fill: currentColor;
        stroke: none;
        transition: transform 0.2s;
      }
      .students-toggle.open svg {
        transform: rotate(180deg);
      }
      .students-content {
        display: none;
        margin-top: 8px;
      }
      .students-content.open {
        display: block;
      }
      .add-student-bottom {
        margin-top: 8px;
      }
      .add-student-bottom button {
        width: 100%;
        padding: 10px 16px;
        font-size: 13px;
        border: none;
        outline: none;
        border-radius: 12px;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        font-weight: 500;
        font-family: inherit;
        cursor: pointer;
        transition: var(--transition);
      }
      .add-student-bottom button:hover {
        border: none;
        color: var(--text-primary);
      }

      /* ===== NAV TABS ===== */
      .nav-tabs {
        display: flex;
        gap: 6px;
        flex-direction: column;
        margin-top: 16px;
        padding-top: 16px;
        border-top: none;
      }
      .nav-tab {
        position: relative;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 9px 16px;
        border: none;
        background: transparent;
        border-radius: 12px;
        cursor: pointer;
        font-size: 13px;
        color: var(--text-muted);
        text-align: left;
        width: 100%;
        font-family: inherit;
        transition: var(--transition);
        font-weight: 400;
      }
      .nav-tab::before {
        content: "";
        position: absolute;
        left: 0;
        top: 20%;
        width: 3px;
        height: 60%;
        background: var(--text-primary);
        border-radius: 0 2px 2px 0;
        opacity: 0;
        transition: opacity 0.2s;
        display: none;
      }
      .nav-tab:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        transform: translateX(2px);
      }
      .nav-tab:active {
        transform: translateX(1px);
      }
      .nav-tab.active {
        background: var(--bg-active);
        color: var(--text-primary);
        font-weight: 500;
        border: none;
        animation: borderGlow 3s ease-in-out infinite;
      }
      .nav-tab.active::before {
        opacity: 1;
      }
      .nav-tab svg {
        width: 16px;
        height: 16px;
        fill: currentColor;
        stroke: none;
        flex-shrink: 0;
        transition: transform 0.2s;
      }
      .nav-tab:hover svg {
        transform: scale(1.1);
      }

      /* ===== TAB VISIBILITY EYE ICON ===== */
      .tab-eye-btn {
        display: none;
        align-items: center;
        justify-content: center;
        width: 22px;
        height: 22px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        color: var(--text-muted);
        padding: 0;
        margin-left: auto;
        flex-shrink: 0;
        opacity: 0;
        transition: opacity 0.15s, color 0.15s, background 0.15s;
      }
      .admin-mode .tab-eye-btn {
        display: flex;
      }
      .nav-tab:hover .tab-eye-btn,
      .nav-tab .tab-eye-btn.tab-hidden {
        opacity: 1;
      }
      .tab-eye-btn:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }
      .tab-eye-btn svg {
        width: 14px !important;
        height: 14px !important;
        flex-shrink: 0;
      }
      .tab-eye-btn.tab-hidden {
        color: var(--text-muted);
        opacity: 0.7;
      }
      .nav-tab.tab-is-hidden {
        opacity: 0.35;
      }
      .nav-tab.tab-is-hidden:hover {
        opacity: 0.6;
      }

      .tab-filter-row {
        display: none;
        gap: 4px;
        margin-bottom: 8px;
        padding: 0 4px;
      }
      .admin-mode .tab-filter-row {
        display: flex;
      }
      .tab-filter-btn {
        flex: 1;
        padding: 4px 0;
        font-size: 11px;
        font-weight: 600;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        font-family: inherit;
        transition: all 0.15s;
      }
      .tab-filter-btn:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }
      .tab-filter-btn.active {
        background: var(--bg-active);
        color: var(--text-primary);
        border-color: var(--text-muted);
      }

      /* ===== CLASSES TAB ===== */
      .classes-subnav {
        display: flex;
        gap: 4px;
        margin-bottom: 16px;
        background: var(--bg-secondary);
        padding: 4px;
        border-radius: 12px;
      }
      .classes-subnav-btn {
        flex: 1;
        padding: 8px 0;
        font-size: 12px;
        font-weight: 700;
        border: none;
        border-radius: 8px;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        font-family: inherit;
        transition: all 0.2s;
      }
      .classes-subnav-btn:hover {
        color: var(--text-primary);
        background: var(--bg-tertiary);
      }
      .classes-subnav-btn.active {
        background: var(--bg-primary);
        color: var(--text-primary);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      .classes-subnav-btn .subnav-emoji { margin-right: 4px; }

      .class-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 10px;
        transition: all 0.2s;
      }
      .class-card:hover {
        border-color: var(--text-muted);
      }
      .class-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
      }
      .class-card-date {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 700;
        font-size: 14px;
        color: var(--text-primary);
      }
      .class-card-date small {
        font-weight: 500;
        color: var(--text-muted);
        font-size: 12px;
      }
      .class-card-badge {
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .class-card-badge.past {
        background: rgba(107, 114, 128, 0.15);
        color: var(--text-muted);
      }
      .class-card-badge.next {
        background: rgba(79, 70, 229, 0.15);
        color: #818CF8;
      }
      .class-card-badge.future {
        background: rgba(16, 185, 129, 0.15);
        color: #10B981;
      }
      .class-card-body {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .class-card-field {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.5;
      }
      .class-card-field-icon {
        flex-shrink: 0;
        margin-top: 2px;
      }
      .class-card-field strong {
        color: var(--text-primary);
        font-weight: 600;
      }
      .class-card-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 2px;
      }
      .class-card-tag {
        background: rgba(79, 70, 229, 0.1);
        color: #818CF8;
        padding: 2px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
      }
      .class-card-actions {
        display: flex;
        gap: 6px;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid var(--border);
      }
      .class-next-hero {
        background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(124, 58, 237, 0.05));
        border: 2px solid rgba(79, 70, 229, 0.2);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 16px;
        text-align: center;
      }
      .class-next-hero .hero-emoji { font-size: 3rem; margin-bottom: 8px; }
      .class-next-hero .hero-date {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--text-primary);
      }
      .class-next-hero .hero-time {
        font-size: 1rem;
        color: #818CF8;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .class-next-hero .hero-countdown {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-top: 4px;
      }
      .class-next-details {
        text-align: left;
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .classes-empty {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-muted);
      }
      .classes-empty-emoji { font-size: 3rem; margin-bottom: 8px; }
      .classes-empty-text { font-size: 14px; }

      /* ===== MAIN PANEL ===== */
      .main-panel {
        flex: 1;
        padding: 20px;
        background: var(--bg-secondary);
        border: none;
        border-radius: 12px;
        box-shadow: var(--shadow-section);
        overflow-y: auto;
        animation: fadeIn 0.4s ease 0.15s both;
      }
      .welcome-content {
        text-align: center;
        padding: 80px 20px;
      }
      .welcome-content svg {
        width: 48px;
        height: 48px;
        stroke: var(--text-muted);
        fill: none;
        stroke-width: 1.5;
        margin-bottom: 20px;
      }
      .welcome-content h2 {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 8px;
        letter-spacing: -0.02em;
      }
      .welcome-content p {
        color: var(--text-muted);
        font-size: 14px;
      }
      .btn-small {
        padding: 3px 10px;
        font-size: 11px;
        background: var(--bg-elevated);
        color: var(--text-primary);
        border: 1px solid var(--border);
        border-radius: 20px;
        cursor: pointer;
        font-family: inherit;
        font-weight: 500;
        letter-spacing: 0.02em;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .btn-small:hover {
        background: var(--bg-tertiary);
        border-color: var(--border-hover);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }
      .btn-small:active {
        transform: translateY(0) scale(0.97);
      }
      .btn-small svg {
        width: 14px;
        height: 14px;
        fill: currentColor;
        stroke: none;
      }
      .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
        font-size: 14px;
        display: none;
      }
      .panel {
        display: none;
      }
      .panel.active {
        display: block;
        animation: slideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .panel-header {
        display: none;
      }
      .panel-header h2 {
        font-size: 18px;
        font-weight: 600;
        letter-spacing: -0.02em;
      }

      /* ===== CARDS ===== */
      .items-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .add-item-card {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        background: none;
        border: none;
        cursor: pointer;
        position: relative;
        z-index: 1;
      }
      .add-item-card .btn-small {
        padding: 10px 20px;
        font-size: 13px;
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        transition: var(--transition);
        font-family: inherit;
        font-weight: 500;
      }
      .add-item-card .btn-small:hover {
        color: var(--text-primary);
      }
      .item-card {
        display: flex;
        gap: 16px;
        padding: 16px;
        background: var(--bg-secondary);
        border: none;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-card);
        transition: var(--transition);
        animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        margin-bottom: 0;
      }
      .item-card:nth-child(2) {
        animation-delay: 0.04s;
      }
      .item-card:nth-child(3) {
        animation-delay: 0.08s;
      }
      .item-card:nth-child(4) {
        animation-delay: 0.12s;
      }
      .item-card:nth-child(5) {
        animation-delay: 0.16s;
      }
      .item-card:hover {
        border-color: var(--border-hover);
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      }
      .item-card:active {
        transform: translateY(0);
      }
      .item-card:hover .item-icon {
        background: rgba(255, 255, 255, 0.06);
        transform: scale(1.05);
      }
      .item-icon {
        display: none;
      }
        flex-shrink: 0;
        transition: var(--transition);
      }
      .item-icon svg {
        width: 18px;
        height: 18px;
        fill: var(--text-secondary);
        stroke: none;
      }
      .item-content {
        flex: 1;
        min-width: 0;
      }
      .item-title {
        font-weight: 500;
        font-size: 14px;
        margin-bottom: 2px;
      }
      .item-desc {
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 8px;
      }
      .status-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 500;
        letter-spacing: 0.02em;
        border: 1px solid var(--border);
      }
      .status-badge.pending {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border: 1px solid var(--border);
      }
      .status-badge.completed {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border: 1px solid var(--border);
      }
      .item-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
        flex-wrap: wrap;
      }

      /* ===== MODAL ===== */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.15s ease;
      }
      .modal {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        width: 100%;
        max-width: 480px;
        max-height: 90vh;
        overflow-y: auto;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid var(--border);
      }
      .modal-header h3 {
        font-size: 16px;
        font-weight: 600;
      }
      .modal-close {
        width: 32px;
        height: 32px;
        border: none;
        background: var(--bg-tertiary);
        border-radius: var(--radius);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        transition: var(--transition);
      }
      .modal-close svg {
        width: 16px;
        height: 16px;
        stroke: currentColor;
        fill: none;
        stroke-width: 2;
      }
      .modal-close:hover {
        background: var(--bg-elevated);
        color: var(--text-primary);
      }
      .modal-content {
        padding: 20px;
      }
      .modal-content .form-group textarea {
        width: 100%;
        padding: 12px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
        color: var(--text-primary);
        outline: none;
      }
      .modal-content .form-group textarea:focus {
        border-color: var(--border-hover);
      }

      /* ===== DIAGNOSTIC OVERLAY ===== */
      .diag-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--bg-primary);
        z-index: 2000;
        display: none;
        flex-direction: column;
      }
      .diag-overlay.active {
        display: flex;
      }
      .diag-header {
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
        padding: 0 24px;
        height: 56px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .diag-header h2 {
        font-size: 16px;
        font-weight: 600;
      }
      .diag-close {
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        color: var(--text-secondary);
        width: 32px;
        height: 32px;
        border-radius: var(--radius);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
      }
      .diag-close svg {
        width: 16px;
        height: 16px;
        stroke: currentColor;
        fill: none;
        stroke-width: 2;
      }
      .diag-close:hover {
        background: var(--bg-elevated);
        color: var(--text-primary);
      }
      .diag-progress {
        background: var(--bg-secondary);
        padding: 12px 24px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .diag-progress-bar {
        flex: 1;
        height: 4px;
        background: var(--bg-tertiary);
        border-radius: 2px;
        overflow: hidden;
      }
      .diag-progress-fill {
        height: 100%;
        background: var(--green);
        transition: width 0.3s;
      }
      .diag-progress-text {
        font-size: 12px;
        color: var(--text-muted);
        min-width: 100px;
        text-align: right;
      }
      .diag-body {
        flex: 1;
        display: flex;
        overflow: hidden;
      }
      .diag-sidebar {
        width: 260px;
        background: var(--bg-secondary);
        border-right: 1px solid var(--border);
        overflow-y: auto;
        padding: 16px;
      }
      .diag-section-nav {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .diag-section-btn {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border: none;
        background: transparent;
        border-radius: var(--radius);
        cursor: pointer;
        text-align: left;
        font-family: inherit;
        font-size: 13px;
        color: var(--text-muted);
        transition: var(--transition);
      }
      .diag-section-btn:hover {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
      }
      .diag-section-btn.active {
        background: var(--bg-elevated);
        color: var(--text-primary);
        font-weight: 500;
      }
      .diag-section-btn.completed {
        color: var(--green);
      }
      .diag-section-btn .check {
        margin-left: auto;
      }
      .diag-section-btn .check svg {
        width: 14px;
        height: 14px;
        stroke: var(--green);
        fill: none;
        stroke-width: 2;
      }
      .diag-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .diag-content {
        flex: 1;
        overflow-y: auto;
        padding: 32px;
      }
      .diag-section-header {
        margin-bottom: 24px;
      }
      .diag-section-header h3 {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 8px;
        letter-spacing: -0.02em;
      }
      .diag-section-header .category {
        display: inline-block;
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 500;
        margin-bottom: 12px;
        border: 1px solid var(--border);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .diag-section-header .instruction {
        color: var(--text-muted);
        font-size: 14px;
        line-height: 1.6;
      }
      .diag-section-header .tip {
        margin-top: 12px;
        padding: 12px 16px;
        background: rgba(234, 179, 8, 0.06);
        border: 1px solid rgba(234, 179, 8, 0.15);
        border-radius: var(--radius);
        font-size: 13px;
        color: var(--yellow);
        display: flex;
        align-items: flex-start;
        gap: 8px;
      }
      .diag-section-header .tip svg {
        width: 16px;
        height: 16px;
        stroke: var(--yellow);
        fill: none;
        stroke-width: 1.5;
        flex-shrink: 0;
        margin-top: 1px;
      }
      .diag-items {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .diag-item {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 14px 16px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        transition: var(--transition);
      }
      .diag-item:hover {
        border-color: var(--border-hover);
      }
      .diag-item.answered {
        border-color: rgba(34, 197, 94, 0.3);
        background: rgba(34, 197, 94, 0.04);
      }
      .diag-item-emoji {
        font-size: 28px;
        width: 40px;
        text-align: center;
      }
      .diag-item-text {
        flex: 1;
      }
      .diag-item-pt {
        font-size: 16px;
        font-weight: 600;
      }
      .diag-item-en {
        font-size: 13px;
        color: var(--text-muted);
      }
      .diag-item-btns {
        display: flex;
        gap: 6px;
      }
      .diag-item-btn {
        width: 40px;
        height: 40px;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        background: var(--bg-tertiary);
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
      }
      .diag-item-btn svg {
        width: 16px;
        height: 16px;
        stroke: currentColor;
        fill: none;
        stroke-width: 2;
      }
      .diag-item-btn:hover {
        transform: scale(1.05);
        border-color: var(--border-hover);
      }
      .diag-item-btn.correct {
        border-color: var(--green);
        background: var(--green);
        color: #000;
      }
      .diag-item-btn.partial {
        border-color: var(--yellow);
        background: var(--yellow);
        color: #000;
      }
      .diag-item-btn.none {
        border-color: var(--red);
        background: var(--red);
        color: #fff;
      }
      .diag-item-btn.selected {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      .diag-footer {
        background: var(--bg-secondary);
        border-top: 1px solid var(--border);
        padding: 16px 32px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .diag-nav-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        font-family: inherit;
        transition: var(--transition);
        background: var(--bg-tertiary);
        color: var(--text-secondary);
      }
      .diag-nav-btn:hover {
        background: var(--bg-elevated);
        color: var(--text-primary);
      }
      .diag-nav-btn.prev {
        background: transparent;
      }
      .diag-nav-btn.next {
        background: var(--text-primary);
        color: var(--bg-primary);
        border-color: transparent;
        box-shadow: 0 0 20px rgba(250, 250, 250, 0.08);
      }
      .diag-nav-btn.next:hover {
        opacity: 0.9;
        box-shadow: 0 0 24px rgba(250, 250, 250, 0.12);
        transform: translateY(-1px);
      }
      .diag-nav-btn.next:active {
        transform: translateY(0) scale(0.97);
      }
      .diag-nav-btn.finish {
        background: var(--green);
        color: #000;
        border-color: transparent;
      }
      .diag-nav-btn.finish:hover {
        opacity: 0.9;
      }
      .diag-nav-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }
      .diag-notes {
        margin-top: 20px;
      }
      .diag-notes textarea {
        width: 100%;
        padding: 14px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
        min-height: 100px;
        color: var(--text-primary);
        outline: none;
        transition: var(--transition);
      }
      .diag-notes textarea:focus {
        border-color: var(--border-hover);
      }
      .diag-notes label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }
      .diag-notes label svg {
        width: 16px;
        height: 16px;
        stroke: currentColor;
        fill: none;
        stroke-width: 1.5;
      }

      /* ===== RESULTS ===== */
      .results-header {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 32px;
        text-align: center;
        margin-bottom: 24px;
      }
      .results-header .score {
        font-size: 48px;
        font-weight: 700;
        margin: 8px 0;
      }
      .results-header .score-sub {
        font-size: 14px;
        color: var(--text-muted);
      }
      .results-header .grade-row {
        display: flex;
        justify-content: center;
        gap: 32px;
        margin-top: 16px;
      }
      .results-header .grade-row div {
        text-align: center;
      }
      .results-header .grade-row .val {
        font-size: 28px;
        font-weight: 700;
      }
      .results-header .grade-row .lbl {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-top: 4px;
      }
      .results-section {
        margin-bottom: 12px;
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        overflow: hidden;
        border: 1px solid var(--border);
      }
      .results-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 16px;
        cursor: pointer;
        transition: var(--transition);
      }
      .results-section-header:hover {
        background: var(--bg-tertiary);
      }
      .results-section-header h4 {
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .results-score {
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 500;
        font-size: 12px;
        border: 1px solid var(--border);
      }
      .results-items {
        padding: 12px 16px;
        display: none;
        border-top: 1px solid var(--border);
      }
      .results-items.open {
        display: block;
      }
      .results-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
      }
      .results-item:last-child {
        border-bottom: none;
      }
      .results-item .r-icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }
      .results-item .r-icon svg {
        width: 16px;
        height: 16px;
        fill: none;
        stroke-width: 2;
      }

      /* ===== DELETE BTN ===== */
      .delete-btn {
        background: var(--bg-tertiary);
        color: var(--text-muted);
        border: 1px solid var(--border);
        padding: 3px 10px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 11px;
        font-family: inherit;
        font-weight: 500;
        letter-spacing: 0.02em;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .delete-btn:hover {
        background: var(--bg-elevated);
        color: var(--text-primary);
      }
      .delete-btn svg {
        width: 14px;
        height: 14px;
        stroke: currentColor;
        fill: none;
        stroke-width: 1.5;
      }

      /* ===== CREDENTIALS ===== */
      .credentials-box {
        background: rgba(34, 197, 94, 0.06);
        border: 1px solid rgba(34, 197, 94, 0.2);
        border-radius: var(--radius-lg);
        padding: 16px;
        margin-top: 16px;
      }
      .credentials-box h4 {
        color: var(--green);
        margin-bottom: 12px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .credentials-box h4 svg {
        width: 16px;
        height: 16px;
        stroke: var(--green);
        fill: none;
        stroke-width: 1.5;
      }
      .credentials-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid rgba(34, 197, 94, 0.1);
      }
      .credentials-item:last-child {
        border-bottom: none;
      }
      .credentials-item label {
        color: var(--text-muted);
        font-size: 13px;
      }
      .credentials-item span {
        font-weight: 600;
        font-family: "SF Mono", SFMono-Regular, Consolas, monospace;
        font-size: 13px;
      }

      /* ===== CLASS LOG ===== */
      .log-entry {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 20px;
        margin-bottom: 12px;
        transition: var(--transition);
        animation: slideUp 0.2s ease;
      }
      .log-entry:hover {
        border-color: var(--border-hover);
      }
      .log-entry-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 14px;
      }
      .log-entry-date {
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .log-entry-date svg {
        width: 16px;
        height: 16px;
        stroke: var(--text-muted);
        fill: none;
        stroke-width: 1.5;
      }
      .log-entry-date small {
        font-weight: 400;
        color: var(--text-muted);
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 4px;
        margin-top: 2px;
      }
      .log-entry-date small svg {
        width: 12px;
        height: 12px;
      }
      .log-detail {
        margin-bottom: 12px;
      }
      .log-detail-label {
        font-size: 11px;
        font-weight: 500;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.06em;
        margin-bottom: 4px;
      }
      .log-detail-value {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.6;
      }
      .log-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 6px;
      }
      .log-tag {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        border: 1px solid var(--border);
      }
      .log-comments {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
      }
      .log-comments h4 {
        font-size: 12px;
        color: var(--text-muted);
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .log-comments h4 svg {
        width: 14px;
        height: 14px;
        stroke: currentColor;
        fill: none;
        stroke-width: 1.5;
      }
      .log-comment {
        background: var(--bg-tertiary);
        border-radius: var(--radius);
        padding: 12px;
        margin-bottom: 6px;
      }
      .log-comment-author {
        font-weight: 500;
        font-size: 13px;
      }
      .log-comment-date {
        font-size: 11px;
        color: var(--text-muted);
        margin-left: 8px;
      }
      .log-comment-text {
        font-size: 13px;
        color: var(--text-secondary);
        margin-top: 4px;
        line-height: 1.5;
      }
      .log-add-comment {
        display: flex;
        gap: 8px;
        margin-top: 10px;
      }
      .log-add-comment input {
        flex: 1;
        padding: 8px 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        font-family: inherit;
        font-size: 13px;
        color: var(--text-primary);
        outline: none;
        transition: var(--transition);
      }
      .log-add-comment input:focus {
        border-color: var(--border-hover);
      }
      .log-add-comment input::placeholder {
        color: var(--text-muted);
      }
      .log-add-comment button {
        padding: 8px 16px;
        background: var(--text-primary);
        color: var(--bg-primary);
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        font-family: inherit;
        font-size: 13px;
        font-weight: 500;
        white-space: nowrap;
        transition: var(--transition);
      }
      .log-add-comment button:hover {
        opacity: 0.9;
      }

      /* ===== LOADER ===== */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #000;
        z-index: 10000;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0;
      }
      .loading-overlay.visible {
        display: flex;
      }
      .loading-overlay.fade-out {
        animation: fadeOutOverlay 0.5s ease forwards;
      }
      @keyframes fadeOutOverlay {
        from { opacity: 1; }
        to { opacity: 0; }
      }
      .loading-logo {
        transform: scale(2.5);
        margin-bottom: 24px;
      }
      .loading-overlay.visible .loading-logo {
        animation: logoZoomOut 0.8s cubic-bezier(0.16, 1, 0.3, 1) 2.2s forwards;
      }
      .loading-logo .logo-b {
        stroke-dasharray: 400;
        stroke-dashoffset: 400;
      }
      .loading-overlay.visible .loading-logo .logo-b {
        animation: drawB 1s ease-out 0.3s forwards;
      }
      .loading-logo .logo-b-bar {
        stroke-dasharray: 38;
        stroke-dashoffset: 38;
      }
      .loading-overlay.visible .loading-logo .logo-b-bar {
        animation: drawBbar 0.3s ease-out 0.9s forwards;
      }
      .loading-logo .logo-l {
        stroke-dasharray: 160;
        stroke-dashoffset: 160;
      }
      .loading-overlay.visible .loading-logo .logo-l {
        animation: drawL 0.7s ease-out 1.1s forwards;
      }
      .loading-welcome {
        font-size: 28px;
        font-weight: 600;
        margin: 0 0 8px 0;
        color: var(--text-primary);
        opacity: 0;
      }
      .loading-overlay.visible .loading-welcome {
        animation: fadeInUp 0.6s ease-out 3s forwards;
      }
      .loading-name {
        font-size: 18px;
        color: var(--text-secondary);
        margin: 0 0 32px 0;
        opacity: 0;
      }
      .loading-overlay.visible .loading-name {
        animation: fadeInUp 0.5s ease-out 3.2s forwards;
      }
      .loader {
        display: inline-flex;
        gap: 4px;
        padding: 20px;
        justify-content: center;
        width: 100%;
      }
      .loader span {
        width: 6px;
        height: 6px;
        background: var(--text-muted);
        border-radius: 50%;
        animation: pulse 1.2s ease-in-out infinite;
      }
      .loader span:nth-child(2) {
        animation-delay: 0.2s;
      }
      .loader span:nth-child(3) {
        animation-delay: 0.4s;
      }

      /* ===== ANIMATIONS ===== */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes pulse {
        0%,
        80%,
        100% {
          opacity: 0.3;
          transform: scale(0.8);
        }
        40% {
          opacity: 1;
          transform: scale(1);
        }
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes drawB {
        from {
          stroke-dashoffset: 400;
        }
        to {
          stroke-dashoffset: 0;
        }
      }
      @keyframes drawBbar {
        from {
          stroke-dashoffset: 38;
        }
        to {
          stroke-dashoffset: 0;
        }
      }
      @keyframes drawL {
        from {
          stroke-dashoffset: 160;
        }
        to {
          stroke-dashoffset: 0;
        }
      }
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes logoZoomOut {
        0% {
          transform: scale(2.5);
        }
        100% {
          transform: scale(1);
        }
      }
      .logo-icon {
        animation: logoZoomOut 0.8s cubic-bezier(0.16, 1, 0.3, 1) 2.2s forwards;
        transform: scale(2.5);
      }
      .logo-icon .logo-b {
        stroke-dasharray: 400;
        stroke-dashoffset: 400;
        animation: drawB 1s ease-out 0.3s forwards;
      }
      .logo-icon .logo-b-bar {
        stroke-dasharray: 38;
        stroke-dashoffset: 38;
        animation: drawBbar 0.3s ease-out 0.9s forwards;
      }
      .logo-icon .logo-l {
        stroke-dasharray: 160;
        stroke-dashoffset: 160;
        animation: drawL 0.7s ease-out 1.1s forwards;
      }
      .login-header h1 {
        opacity: 0;
        animation: fadeInUp 0.6s ease-out 3s forwards;
      }
      .login-header .subtitle {
        opacity: 0;
        animation: fadeInUp 0.5s ease-out 3.2s forwards;
      }
      #login-screen > .by-line {
        opacity: 0;
        animation: fadeInUp 0.5s ease-out 4s forwards;
        text-align: center;
      }
      #login-form {
        opacity: 0;
        animation: fadeInUp 0.6s ease-out 3.6s forwards;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ===== SEARCH BAR ===== */
      .search-bar {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 14px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        margin-bottom: 12px;
        transition: var(--transition);
      }
      .search-bar:focus-within {
        border-color: var(--border-hover);
        background: var(--bg-secondary);
      }
      .search-bar svg {
        width: 16px;
        height: 16px;
        stroke: var(--text-muted);
        fill: none;
        stroke-width: 1.5;
        flex-shrink: 0;
      }
      .search-bar input {
        flex: 1;
        background: none;
        border: none;
        outline: none;
        font-family: inherit;
        font-size: 13px;
        color: var(--text-primary);
      }
      .search-bar input::placeholder {
        color: var(--text-muted);
      }

      /* ===== VOCABULARY BANK ===== */
      .vocab-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        background: var(--bg-secondary);
        border: none;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-card);
        transition: var(--transition);
        animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .vocab-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      }
      .vocab-emoji {
        font-size: 28px;
        line-height: 1;
      }
      .vocab-content {
        flex: 1;
        min-width: 0;
      }
      .vocab-pt {
        font-weight: 600;
        font-size: 15px;
        margin-bottom: 2px;
      }
      .vocab-en {
        font-size: 13px;
        color: var(--text-muted);
      }
      .vocab-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 4px;
      }
      .vocab-category {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 20px;
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border: 1px solid var(--border);
        font-weight: 500;
      }
      .vocab-mastery {
        font-size: 11px;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .vocab-mastery-bar {
        width: 40px;
        height: 4px;
        background: var(--bg-tertiary);
        border-radius: 2px;
        overflow: hidden;
      }
      .vocab-mastery-fill {
        height: 100%;
        border-radius: 2px;
        transition: width 0.3s;
      }
      [data-theme="light"] .vocab-card {
        background: #f9f9fb;
      }

      /* ===== HOMEWORK TRACKER ===== */
      .homework-card {
        padding: 16px;
        background: var(--bg-secondary);
        border: none;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-card);
        transition: var(--transition);
        animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .homework-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      }
      .homework-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
      }
      .homework-title {
        font-weight: 600;
        font-size: 14px;
      }
      .homework-due {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 20px;
        font-weight: 500;
      }
      .homework-due.overdue {
        background: rgba(239, 68, 68, 0.1);
        color: var(--red);
      }
      .homework-due.today {
        background: rgba(234, 179, 8, 0.1);
        color: var(--yellow);
      }
      .homework-due.upcoming {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
      }
      .homework-desc {
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 8px;
        line-height: 1.5;
      }
      .homework-progress {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
      }
      .homework-progress-bar {
        flex: 1;
        height: 6px;
        background: var(--bg-tertiary);
        border-radius: 3px;
        overflow: hidden;
      }
      .homework-progress-fill {
        height: 100%;
        background: var(--green);
        border-radius: 3px;
        transition: width 0.3s;
      }
      .homework-progress-text {
        font-size: 11px;
        color: var(--text-muted);
        min-width: 30px;
        text-align: right;
      }
      [data-theme="light"] .homework-card {
        background: #f9f9fb;
      }

      /* ===== CLASS TIMER ===== */
      .timer-widget {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 900;
        display: none;
      }
      .timer-widget.visible {
        display: block;
        animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .timer-fab {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        font-family: inherit;
      }
      .timer-fab:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 28px rgba(0, 0, 0, 0.4);
      }
      .timer-fab svg {
        width: 24px;
        height: 24px;
        stroke: var(--text-primary);
        fill: none;
        stroke-width: 1.5;
      }
      .timer-fab .timer-fab-time {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
      }
      .timer-panel {
        position: absolute;
        bottom: 68px;
        right: 0;
        width: 240px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        padding: 20px;
        display: none;
      }
      .timer-panel.open {
        display: block;
        animation: slideUp 0.2s ease;
      }
      .timer-display {
        text-align: center;
        font-size: 36px;
        font-weight: 700;
        font-variant-numeric: tabular-nums;
        margin-bottom: 16px;
        letter-spacing: -0.02em;
      }
      .timer-controls {
        display: flex;
        gap: 8px;
        justify-content: center;
      }
      .timer-btn {
        padding: 8px 16px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: var(--bg-tertiary);
        color: var(--text-primary);
        cursor: pointer;
        font-family: inherit;
        font-size: 12px;
        font-weight: 500;
        transition: var(--transition);
      }
      .timer-btn:hover {
        background: var(--bg-elevated);
      }
      .timer-btn.primary {
        background: var(--text-primary);
        color: var(--bg-primary);
        border-color: transparent;
      }
      .timer-btn.primary:hover {
        opacity: 0.9;
      }
      .timer-presets {
        display: flex;
        gap: 6px;
        margin-top: 12px;
        flex-wrap: wrap;
        justify-content: center;
      }
      .timer-preset {
        padding: 4px 10px;
        border: 1px solid var(--border);
        border-radius: 20px;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        font-family: inherit;
        font-size: 11px;
        transition: var(--transition);
      }
      .timer-preset:hover {
        border-color: var(--border-hover);
        color: var(--text-primary);
      }

      /* ===== LESSON PLANNER ===== */
      .planner-week {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 6px;
        margin-bottom: 16px;
      }
      .planner-day {
        padding: 10px 8px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
        min-height: 70px;
      }
      .planner-day:hover {
        border-color: var(--border-hover);
      }
      .planner-day.today {
        border-color: var(--text-primary);
      }
      .planner-day.has-lesson {
        background: var(--bg-tertiary);
      }
      .planner-day-label {
        font-size: 10px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 4px;
      }
      .planner-day-num {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 4px;
      }
      .planner-day-dot {
        width: 6px;
        height: 6px;
        background: var(--green);
        border-radius: 50%;
        margin: 4px auto 0;
      }
      .planner-lesson {
        padding: 12px 16px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-card);
        margin-bottom: 8px;
      }
      .planner-lesson-time {
        font-size: 12px;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
      }
      .planner-lesson-title {
        font-weight: 600;
        font-size: 14px;
      }
      .planner-lesson-topics {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 6px;
      }

      /* ===== PROGRESS CHARTS ===== */
      .progress-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
      }
      .progress-stat {
        padding: 16px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        text-align: center;
        transition: var(--transition);
      }
      .progress-stat:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .progress-stat-value {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 4px;
      }
      .progress-stat-label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .progress-chart {
        padding: 16px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        margin-bottom: 16px;
      }
      .progress-chart h4 {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 12px;
      }
      .bar-chart {
        display: flex;
        align-items: flex-end;
        gap: 6px;
        height: 120px;
        padding-top: 8px;
      }
      .bar-chart-col {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        height: 100%;
        justify-content: flex-end;
      }
      .bar-chart-bar {
        width: 100%;
        max-width: 32px;
        border-radius: 4px 4px 0 0;
        background: var(--text-muted);
        transition: height 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        opacity: 0.6;
      }
      .bar-chart-label {
        font-size: 10px;
        color: var(--text-muted);
        text-align: center;
      }

      /* ===== DRAG REORDER ===== */
      .item-card.dragging {
        opacity: 0.5;
        transform: scale(0.98);
      }
      .item-card.game-completed {
        opacity: 0.55;
        border-left: 3px solid var(--text-muted);
      }
      .games-section-label {
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-muted);
        padding: 12px 0 6px;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 8px;
      }
      .item-card.drag-over {
        border-top: 2px solid var(--text-primary);
      }
      .drag-handle {
        cursor: grab;
        padding: 4px;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        opacity: 0;
        transition: opacity 0.2s;
      }
      .item-card:hover .drag-handle {
        opacity: 1;
      }
      .drag-handle:active {
        cursor: grabbing;
      }
      .drag-handle svg {
        width: 14px;
        height: 14px;
        fill: currentColor;
        stroke: none;
      }

      /* ===== PROFILE MODAL ===== */
      .profile-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s;
      }
      .profile-overlay.visible {
        opacity: 1;
        pointer-events: auto;
      }
      .profile-card {
        background: var(--bg-elevated, #1a1a2e);
        border: 1px solid var(--border, rgba(255,255,255,0.08));
        border-radius: 16px;
        padding: 32px;
        width: 380px;
        max-width: 92vw;
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        transform: translateY(20px) scale(0.96);
        transition: transform 0.3s;
        text-align: center;
      }
      .profile-overlay.visible .profile-card {
        transform: translateY(0) scale(1);
      }
      .profile-avatar-wrapper {
        position: relative;
        width: 96px;
        height: 96px;
        margin: 0 auto 20px;
        cursor: pointer;
      }
      .profile-avatar-wrapper:hover .profile-avatar-edit {
        opacity: 1;
      }
      .profile-avatar-lg {
        width: 96px;
        height: 96px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        font-size: 36px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 3px solid var(--border, rgba(255,255,255,0.1));
        overflow: hidden;
        background-size: cover;
        background-position: center;
      }
      .profile-avatar-edit {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0,0,0,0.65);
        color: #fff;
        font-size: 11px;
        padding: 4px 0;
        text-align: center;
        border-radius: 0 0 48px 48px;
        opacity: 0;
        transition: opacity 0.2s;
        pointer-events: none;
      }
      .profile-name-input {
        width: 100%;
        text-align: center;
        font-size: 20px;
        font-weight: 700;
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        color: var(--text-primary, #fff);
        padding: 6px 0;
        margin-bottom: 4px;
        font-family: 'Inter', sans-serif;
        outline: none;
        transition: border-color 0.2s;
      }
      .profile-name-input:focus {
        border-bottom-color: #667eea;
      }
      .profile-meta {
        color: var(--text-muted, #999);
        font-size: 13px;
        margin-bottom: 20px;
      }
      .profile-field {
        text-align: left;
        margin-bottom: 14px;
      }
      .profile-field label {
        display: block;
        font-size: 12px;
        color: var(--text-muted, #999);
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .profile-field input,
      .profile-field select {
        width: 100%;
        background: var(--bg-secondary, #141421);
        border: 1px solid var(--border, rgba(255,255,255,0.08));
        border-radius: 8px;
        padding: 10px 12px;
        color: var(--text-primary, #fff);
        font-size: 14px;
        font-family: 'Inter', sans-serif;
        outline: none;
        transition: border-color 0.2s;
        box-sizing: border-box;
      }
      .profile-field input:focus,
      .profile-field select:focus {
        border-color: #667eea;
      }
      .profile-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .profile-actions button {
        flex: 1;
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        font-family: 'Inter', sans-serif;
        transition: all 0.2s;
      }
      .profile-btn-save {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
      }
      .profile-btn-save:hover {
        filter: brightness(1.1);
        transform: translateY(-1px);
      }
      .profile-btn-cancel {
        background: var(--bg-secondary, #141421);
        color: var(--text-secondary, #ccc);
        border: 1px solid var(--border, rgba(255,255,255,0.08)) !important;
      }
      .profile-btn-cancel:hover {
        background: var(--bg-tertiary, #1e1e32);
      }

      /* ===== PHOTO AVATAR ===== */
      .student-avatar.has-photo {
        background-size: cover;
        background-position: center;
        color: transparent;
        border: 2px solid var(--border);
      }
      .student-avatar.has-photo:hover {
        border-color: var(--border-hover);
      }
      .avatar-upload-label {
        display: block;
        text-align: center;
        margin-top: 12px;
        cursor: pointer;
        color: var(--text-muted);
        font-size: 12px;
        transition: color 0.2s;
      }
      .avatar-upload-label:hover {
        color: var(--text-primary);
      }

      /* ===== SCROLLBAR ===== */
      ::-webkit-scrollbar {
        width: 4px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.06);
        border-radius: 2px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.15);
      }
    </style>
  </head>
  <body class="login-view">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
      <div class="loading-logo">
        <svg viewBox="-2 -2 100 114" width="72" height="78" fill="none">
          <path
            class="logo-b"
            d="M10,6 L48,6 L58,16 L58,38 L48,48 L58,58 L58,84 L48,96 L10,96 Z"
            stroke="#fafafa"
            stroke-width="2.5"
            fill="none"
            stroke-linejoin="miter"
          />
          <line
            class="logo-b-bar"
            x1="10"
            y1="48"
            x2="48"
            y2="48"
            stroke="#fafafa"
            stroke-width="2.5"
          />
          <polyline
            class="logo-l"
            points="70,4 70,70 48,96 92,96"
            stroke="#fafafa"
            stroke-width="2.5"
            fill="none"
            stroke-linejoin="miter"
          />
        </svg>
      </div>
      <h2 class="loading-welcome">Welcome</h2>
      <p id="loading-user-name" class="loading-name"></p>
    </div>
    <!-- Login Screen -->
    <div id="login-screen">
      <div class="login-header">
        <div class="logo-icon">
          <svg viewBox="-2 -2 100 114" width="48" height="52" fill="none">
            <path
              class="logo-b"
              d="M10,6 L48,6 L58,16 L58,38 L48,48 L58,58 L58,84 L48,96 L10,96 Z"
              stroke="#fafafa"
              stroke-width="2.5"
              fill="none"
              stroke-linejoin="miter"
              stroke-linecap="butt"
            />
            <line
              class="logo-b-bar"
              x1="10"
              y1="48"
              x2="48"
              y2="48"
              stroke="#fafafa"
              stroke-width="2.5"
            />
            <polyline
              class="logo-l"
              points="70,4 70,70 48,96 92,96"
              stroke="#fafafa"
              stroke-width="2.5"
              fill="none"
              stroke-linejoin="miter"
              stroke-linecap="butt"
            />
          </svg>
        </div>
        <h1>The Burnay Lab</h1>
        <p style="font-size:0.55rem;color:rgba(255,255,255,0.25);margin:-4px 0 2px;font-weight:300;letter-spacing:0.8px;">by Tomás Burnay Batalha</p>
        <p class="subtitle">Education Research &amp; Mentoring Studio</p>
      </div>
      <form id="login-form">
        <div class="form-group">
          <input type="text" id="username" required placeholder="Username" />
        </div>
        <div class="form-group">
          <input
            type="password"
            id="password"
            required
            placeholder="Password"
          />
        </div>
        <div class="remember-row">
          <input type="checkbox" id="remember-me" />
          <label for="remember-me">Remember me</label>
        </div>
        <button type="submit" class="btn" id="sign-in-btn">Sign In</button>
        <div id="login-error" class="error-message"></div>
      </form>
      <p class="by-line">
        By
        <a href="https://www.linkedin.com/in/tomasmbatalha" target="_blank"
          >Tomás Burnay Batalha</a
        >
      </p>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboard-screen">
      <header class="main-header">
        <div class="header-left">
          <div class="logo-small">
            <svg viewBox="-2 -2 100 114" width="26" height="28" fill="none">
              <path
                d="M10,6 L48,6 L58,16 L58,38 L48,48 L58,58 L58,84 L48,96 L10,96 Z"
                stroke="#fafafa"
                stroke-width="2.5"
                fill="none"
                stroke-linejoin="miter"
                stroke-linecap="butt"
              />
              <line
                x1="10"
                y1="48"
                x2="48"
                y2="48"
                stroke="#fafafa"
                stroke-width="2.5"
              />
              <polyline
                points="70,4 70,70 48,96 92,96"
                stroke="#fafafa"
                stroke-width="2.5"
                fill="none"
                stroke-linejoin="miter"
                stroke-linecap="butt"
              />
            </svg>
          </div>
          <h1>The Burnay Lab</h1>
          <p style="font-size:0.5rem;color:rgba(255,255,255,0.2);margin:-1px 0 0;font-weight:300;letter-spacing:0.5px;">by Tomás Burnay Batalha</p>
        </div>
        <div class="header-right">
          <button
            id="theme-toggle"
            class="btn-icon"
            title="Toggle light/dark mode"
            onclick="toggleTheme()"
            style="padding: 6px"
          >
            <svg
              id="theme-icon-moon"
              viewBox="0 0 24 24"
              fill="currentColor"
              width="16"
              height="16"
            >
              <path
                fill-rule="evenodd"
                d="M9.528 1.718a.75.75 0 0 1 .162.819A8.97 8.97 0 0 0 9 6a9 9 0 0 0 9 9 8.97 8.97 0 0 0 3.463-.69.75.75 0 0 1 .981.98 10.503 10.503 0 0 1-9.694 6.46c-5.799 0-10.5-4.7-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 0 1 .818.162Z"
                clip-rule="evenodd"
              />
            </svg>
            <svg
              id="theme-icon-sun"
              viewBox="0 0 24 24"
              fill="currentColor"
              width="16"
              height="16"
              style="display: none"
            >
              <path
                d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM18.894 6.166a.75.75 0 0 0-1.06-1.06l-1.591 1.59a.75.75 0 1 0 1.06 1.061l1.591-1.59ZM21.75 12a.75.75 0 0 1-.75.75h-2.25a.75.75 0 0 1 0-1.5H21a.75.75 0 0 1 .75.75ZM17.834 18.894a.75.75 0 0 0 1.06-1.06l-1.59-1.591a.75.75 0 1 0-1.061 1.06l1.59 1.591ZM12 18a.75.75 0 0 1 .75.75V21a.75.75 0 0 1-1.5 0v-2.25A.75.75 0 0 1 12 18ZM7.758 17.303a.75.75 0 0 0-1.061-1.06l-1.591 1.59a.75.75 0 0 0 1.06 1.061l1.591-1.59ZM6 12a.75.75 0 0 1-.75.75H3a.75.75 0 0 1 0-1.5h2.25A.75.75 0 0 1 6 12ZM6.697 7.757a.75.75 0 0 0 1.06-1.06l-1.59-1.591a.75.75 0 0 0-1.061 1.06l1.59 1.591Z"
              />
            </svg>
          </button>
          <button
            class="btn-icon"
            title="Edit Profile"
            onclick="openProfile()"
            style="padding: 6px"
          >
            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
              <path
                fill-rule="evenodd"
                d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695Z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
          <span
            id="current-user-name"
            style="
              font-size: 13px;
              color: var(--text-secondary);
              cursor: pointer;
            "
            onclick="openProfile()"
            title="Click to edit profile"
          ></span>
          <svg
            onclick="openProfile()"
            style="
              cursor: pointer;
              width: 12px;
              height: 12px;
              color: var(--text-muted);
              flex-shrink: 0;
            "
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Z"
            ></path>
          </svg>
          <span id="user-role-badge" class="role-badge">admin</span>
          <button id="logout-btn" class="btn-icon" title="Logout">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path
                fill-rule="evenodd"
                d="M7.5 3.75A1.5 1.5 0 0 0 6 5.25v13.5a1.5 1.5 0 0 0 1.5 1.5h6a1.5 1.5 0 0 0 1.5-1.5V15a.75.75 0 0 1 1.5 0v3.75a3 3 0 0 1-3 3h-6a3 3 0 0 1-3-3V5.25a3 3 0 0 1 3-3h6a3 3 0 0 1 3 3V9A.75.75 0 0 1 15 9V5.25a1.5 1.5 0 0 0-1.5-1.5h-6Zm10.72 4.72a.75.75 0 0 1 1.06 0l3 3a.75.75 0 0 1 0 1.06l-3 3a.75.75 0 1 1-1.06-1.06l1.72-1.72H9a.75.75 0 0 1 0-1.5h10.94l-1.72-1.72a.75.75 0 0 1 0-1.06Z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </div>
      </header>
      <div class="main-content">
        <aside class="sidebar">
          <div id="admin-panel">
            <button class="students-toggle" id="students-toggle">
              <span>Students</span>
              <svg
                viewBox="0 0 24 24"
                fill="currentColor"
                width="12"
                height="12"
              >
                <path
                  fill-rule="evenodd"
                  d="M12.53 16.28a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 0 1 1.06-1.06L12 14.69l6.97-6.97a.75.75 0 1 1 1.06 1.06l-7.5 7.5Z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>
            <div class="students-content" id="students-content">
              <div id="student-list" class="student-list">
                <div class="empty-state">No students yet</div>
              </div>
              <div class="add-student-bottom">
                <button
                  id="add-student-btn"
                  class="btn-small"
                  style="width: 100%"
                >
                  + Add Student
                </button>
              </div>
            </div>
          </div>
          <div id="student-nav" class="nav-tabs hidden">
            <div class="tab-filter-row" id="tab-filter-row">
              <button
                class="tab-filter-btn active"
                data-filter="all"
                onclick="filterAdminTabs('all')"
              >
                All
              </button>
              <button
                class="tab-filter-btn"
                data-filter="visible"
                onclick="filterAdminTabs('visible')"
              >
                👁 Visible
              </button>
              <button
                class="tab-filter-btn"
                data-filter="hidden"
                onclick="filterAdminTabs('hidden')"
              >
                🚫 Hidden
              </button>
            </div>
            <button class="nav-tab active" data-tab="diagnostics">
              <svg viewBox="0 0 24 24">
                <path
                  d="M5.625 1.5c-1.036 0-1.875.84-1.875 1.875v17.25c0 1.035.84 1.875 1.875 1.875h12.75c1.035 0 1.875-.84 1.875-1.875V12.75A3.75 3.75 0 0 0 16.5 9h-1.875a1.875 1.875 0 0 1-1.875-1.875V5.25A3.75 3.75 0 0 0 9 1.5H5.625ZM7.5 15a.75.75 0 0 1 .75-.75h7.5a.75.75 0 0 1 0 1.5h-7.5A.75.75 0 0 1 7.5 15Zm.75 2.25a.75.75 0 0 0 0 1.5H12a.75.75 0 0 0 0-1.5H8.25Z"
                />
                <path
                  d="M12.971 1.816A5.23 5.23 0 0 1 14.25 5.25v1.875c0 .207.168.375.375.375H16.5a5.23 5.23 0 0 1 3.434 1.279 9.768 9.768 0 0 0-6.963-6.963Z"
                />
              </svg>
              Diagnostics
              <span
                class="tab-eye-btn"
                onclick="
                  event.stopPropagation();
                  toggleTabEye('diagnostics');
                "
                title="Toggle visibility"
                ><svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
                  <path
                    fill-rule="evenodd"
                    d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.224-10.676-7.69a1.762 1.762 0 0 1 0-1.113ZM17.25 12a5.25 5.25 0 1 1-10.5 0 5.25 5.25 0 0 1 10.5 0Z"
                    clip-rule="evenodd"
                  /></svg
              ></span>
            </button>
            <button class="nav-tab" data-tab="games">
              <svg viewBox="0 0 24 24">
                <path
                  d="M8 6h8a6 6 0 0 1 0 12H8A6 6 0 0 1 8 6Zm0 3a1 1 0 0 0-1 1v.5H6.5a1 1 0 1 0 0 2H7V13a1 1 0 1 0 2 0v-.5h.5a1 1 0 1 0 0-2H9V10a1 1 0 0 0-1-1Zm7.25 0a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5Zm1.5 2.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5Z"
                />
              </svg>
              Games
              <span
                class="tab-eye-btn"
                onclick="
                  event.stopPropagation();
                  toggleTabEye('games');
                "
                title="Toggle visibility"
                ><svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
                  <path
                    fill-rule="evenodd"
                    d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.224-10.676-7.69a1.762 1.762 0 0 1 0-1.113ZM17.25 12a5.25 5.25 0 1 1-10.5 0 5.25 5.25 0 0 1 10.5 0Z"
                    clip-rule="evenodd"
                  /></svg
              ></span>
            </button>
            <button class="nav-tab" data-tab="tests">
              <svg viewBox="0 0 24 24">
                <path
                  d="M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-8.4 8.4a5.25 5.25 0 0 0-1.32 2.214l-.8 2.685a.75.75 0 0 0 .933.933l2.685-.8a5.25 5.25 0 0 0 2.214-1.32l8.4-8.4Z"
                />
                <path
                  d="M5.25 5.25a3 3 0 0 0-3 3v10.5a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3V13.5a.75.75 0 0 0-1.5 0v5.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5V8.25a1.5 1.5 0 0 1 1.5-1.5h5.25a.75.75 0 0 0 0-1.5H5.25Z"
                />
              </svg>
              Tests
              <span
                class="tab-eye-btn"
                onclick="
                  event.stopPropagation();
                  toggleTabEye('tests');
                "
                title="Toggle visibility"
                ><svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
                  <path
                    fill-rule="evenodd"
                    d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.224-10.676-7.69a1.762 1.762 0 0 1 0-1.113ZM17.25 12a5.25 5.25 0 1 1-10.5 0 5.25 5.25 0 0 1 10.5 0Z"
                    clip-rule="evenodd"
                  /></svg
              ></span>
            </button>
            <button class="nav-tab" data-tab="links">
              <svg viewBox="0 0 24 24">
                <path
                  fill-rule="evenodd"
                  d="M19.902 4.098a3.75 3.75 0 0 0-5.304 0l-4.5 4.5a3.75 3.75 0 0 0 1.035 6.037.75.75 0 0 1-.646 1.353 5.25 5.25 0 0 1-1.449-8.45l4.5-4.5a5.25 5.25 0 1 1 7.424 7.424l-1.757 1.757a.75.75 0 1 1-1.06-1.06l1.757-1.757a3.75 3.75 0 0 0 0-5.304Zm-7.389 4.267a.75.75 0 0 1 1-.353 5.25 5.25 0 0 1 1.449 8.45l-4.5 4.5a5.25 5.25 0 1 1-7.424-7.424l1.757-1.757a.75.75 0 1 1 1.06 1.06l-1.757 1.757a3.75 3.75 0 1 0 5.304 5.304l4.5-4.5a3.75 3.75 0 0 0-1.035-6.037.75.75 0 0 1-.354-1Z"
                  clip-rule="evenodd"
                />
              </svg>
              Links
              <span
                class="tab-eye-btn"
                onclick="
                  event.stopPropagation();
                  toggleTabEye('links');
                "
                title="Toggle visibility"
                ><svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
                  <path
                    fill-rule="evenodd"
                    d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.224-10.676-7.69a1.762 1.762 0 0 1 0-1.113ZM17.25 12a5.25 5.25 0 1 1-10.5 0 5.25 5.25 0 0 1 10.5 0Z"
                    clip-rule="evenodd"
                  /></svg
              ></span>
            </button>
            <button class="nav-tab" data-tab="progress">
              <svg viewBox="0 0 24 24">
                <path
                  d="M18.375 2.25c-1.035 0-1.875.84-1.875 1.875v15.75c0 1.035.84 1.875 1.875 1.875h.75c1.035 0 1.875-.84 1.875-1.875V4.125c0-1.036-.84-1.875-1.875-1.875h-.75ZM9.75 8.625c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-.75a1.875 1.875 0 0 1-1.875-1.875V8.625ZM3 13.125c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v6.75c0 1.035-.84 1.875-1.875 1.875h-.75A1.875 1.875 0 0 1 3 19.875v-6.75Z"
                />
              </svg>
              Progress
              <span
                class="tab-eye-btn"
                onclick="
                  event.stopPropagation();
                  toggleTabEye('progress');
                "
                title="Toggle visibility"
                ><svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
                  <path
                    fill-rule="evenodd"
                    d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.224-10.676-7.69a1.762 1.762 0 0 1 0-1.113ZM17.25 12a5.25 5.25 0 1 1-10.5 0 5.25 5.25 0 0 1 10.5 0Z"
                    clip-rule="evenodd"
                  /></svg
              ></span>
            </button>
            <button class="nav-tab" data-tab="classlog">
              <svg viewBox="0 0 24 24">
                <path
                  fill-rule="evenodd"
                  d="M5.625 1.5c-1.036 0-1.875.84-1.875 1.875v17.25c0 1.035.84 1.875 1.875 1.875h12.75c1.035 0 1.875-.84 1.875-1.875V12.75A3.75 3.75 0 0 0 16.5 9h-1.875a1.875 1.875 0 0 1-1.875-1.875V5.25A3.75 3.75 0 0 0 9 1.5H5.625ZM7.5 15a.75.75 0 0 1 .75-.75h7.5a.75.75 0 0 1 0 1.5h-7.5A.75.75 0 0 1 7.5 15Zm.75 2.25a.75.75 0 0 0 0 1.5H12a.75.75 0 0 0 0-1.5H8.25Z"
                  clip-rule="evenodd"
                />
                <path
                  d="M12.971 1.816A5.23 5.23 0 0 1 14.25 5.25v1.875c0 .207.168.375.375.375H16.5a5.23 5.23 0 0 1 3.434 1.279 9.768 9.768 0 0 0-6.963-6.963Z"
                />
              </svg>
              Class Log
              <span
                class="tab-eye-btn"
                onclick="
                  event.stopPropagation();
                  toggleTabEye('classlog');
                "
                title="Toggle visibility"
                ><svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
                  <path
                    fill-rule="evenodd"
                    d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.224-10.676-7.69a1.762 1.762 0 0 1 0-1.113ZM17.25 12a5.25 5.25 0 1 1-10.5 0 5.25 5.25 0 0 1 10.5 0Z"
                    clip-rule="evenodd"
                  /></svg
              ></span>
            </button>
            <button class="nav-tab" data-tab="vocab">
              <svg viewBox="0 0 24 24">
                <path
                  d="M11.7 2.805a.75.75 0 0 1 .6 0A60.65 60.65 0 0 1 22.83 8.72a.75.75 0 0 1-.231 1.337 49.948 49.948 0 0 0-9.902 3.912l-.003.002-.34.18a.75.75 0 0 1-.707 0A50.88 50.88 0 0 0 7.5 12.173v-.224a.36.36 0 0 1 .172-.311 54.615 54.615 0 0 1 4.653-2.52.75.75 0 0 0-.65-1.352 56.123 56.123 0 0 0-4.78 2.589 1.858 1.858 0 0 0-.859 1.228 49.803 49.803 0 0 0-4.634-1.527.75.75 0 0 1-.231-1.337A60.653 60.653 0 0 1 11.7 2.805Z"
                />
                <path
                  d="M13.06 15.473a48.45 48.45 0 0 1 7.666-3.282c.134 1.414.22 2.843.255 4.284a.75.75 0 0 1-.46.711 47.87 47.87 0 0 0-8.105 4.342.75.75 0 0 1-.832 0 47.87 47.87 0 0 0-8.104-4.342.75.75 0 0 1-.461-.71c.035-1.442.121-2.87.255-4.286A48.4 48.4 0 0 1 6 13.18v1.27a1.5 1.5 0 0 0-.14 2.508c-.09.38-.222.753-.397 1.11.452.213.901.434 1.346.661a6.727 6.727 0 0 0 .551-1.607 1.5 1.5 0 0 0 .14-2.67v-.645a48.549 48.549 0 0 1 3.44 1.667 2.25 2.25 0 0 0 2.12 0Z"
                />
                <path
                  d="M4.462 19.462c.42-.419.753-.89 1-1.395.453.214.902.435 1.347.662a6.742 6.742 0 0 1-1.286 1.794.75.75 0 0 1-1.06-1.06Z"
                />
              </svg>
              Vocab Bank
              <span
                class="tab-eye-btn"
                onclick="
                  event.stopPropagation();
                  toggleTabEye('vocab');
                "
                title="Toggle visibility"
                ><svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
                  <path
                    fill-rule="evenodd"
                    d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.224-10.676-7.69a1.762 1.762 0 0 1 0-1.113ZM17.25 12a5.25 5.25 0 1 1-10.5 0 5.25 5.25 0 0 1 10.5 0Z"
                    clip-rule="evenodd"
                  /></svg
              ></span>
            </button>
            <button class="nav-tab" data-tab="homework">
              <svg viewBox="0 0 24 24">
                <path
                  d="M4.5 3.75a3 3 0 0 0-3 3v.75h21v-.75a3 3 0 0 0-3-3h-15Zm17.25 5.25h-19.5v8.25a3 3 0 0 0 3 3h13.5a3 3 0 0 0 3-3V9Zm-9 4.5a.75.75 0 0 0 0 1.5h3.75a.75.75 0 0 0 0-1.5H12.75Z"
                />
              </svg>
              Homework
              <span
                class="tab-eye-btn"
                onclick="
                  event.stopPropagation();
                  toggleTabEye('homework');
                "
                title="Toggle visibility"
                ><svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
                  <path
                    fill-rule="evenodd"
                    d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.224-10.676-7.69a1.762 1.762 0 0 1 0-1.113ZM17.25 12a5.25 5.25 0 1 1-10.5 0 5.25 5.25 0 0 1 10.5 0Z"
                    clip-rule="evenodd"
                  /></svg
              ></span>
            </button>
            <button class="nav-tab" data-tab="planner">
              <svg viewBox="0 0 24 24">
                <path
                  fill-rule="evenodd"
                  d="M6.75 2.25A.75.75 0 0 1 7.5 3v1.5h9V3A.75.75 0 0 1 18 3v1.5h.75a3 3 0 0 1 3 3v11.25a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3V7.5a3 3 0 0 1 3-3H6V3a.75.75 0 0 1 .75-.75Zm13.5 9a1.5 1.5 0 0 0-1.5-1.5H5.25a1.5 1.5 0 0 0-1.5 1.5v7.5a1.5 1.5 0 0 0 1.5 1.5h13.5a1.5 1.5 0 0 0 1.5-1.5v-7.5Z"
                  clip-rule="evenodd"
                />
              </svg>
              Planner
              <span
                class="tab-eye-btn"
                onclick="
                  event.stopPropagation();
                  toggleTabEye('planner');
                "
                title="Toggle visibility"
                ><svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
                  <path
                    fill-rule="evenodd"
                    d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.224-10.676-7.69a1.762 1.762 0 0 1 0-1.113ZM17.25 12a5.25 5.25 0 1 1-10.5 0 5.25 5.25 0 0 1 10.5 0Z"
                    clip-rule="evenodd"
                  /></svg
              ></span>
            </button>
            <button class="nav-tab" data-tab="classbook">
              <svg viewBox="0 0 24 24">
                <path
                  d="M11.25 4.533A9.707 9.707 0 0 0 6 3a9.735 9.735 0 0 0-3.25.555.75.75 0 0 0-.5.707v14.25a.75.75 0 0 0 1 .707A8.237 8.237 0 0 1 6 18.75c1.995 0 3.823.707 5.25 1.886V4.533ZM12.75 20.636A8.214 8.214 0 0 1 18 18.75c.966 0 1.89.166 2.75.47a.75.75 0 0 0 1-.708V4.262a.75.75 0 0 0-.5-.707A9.735 9.735 0 0 0 18 3a9.707 9.707 0 0 0-5.25 1.533v16.103Z"
                />
              </svg>
              Class Book
              <span
                class="tab-eye-btn"
                onclick="
                  event.stopPropagation();
                  toggleTabEye('classbook');
                "
                title="Toggle visibility"
                ><svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
                  <path
                    fill-rule="evenodd"
                    d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.224-10.676-7.69a1.762 1.762 0 0 1 0-1.113ZM17.25 12a5.25 5.25 0 1 1-10.5 0 5.25 5.25 0 0 1 10.5 0Z"
                    clip-rule="evenodd"
                  /></svg
              ></span>
            </button>
            <button class="nav-tab" data-tab="classes">
              <svg viewBox="0 0 24 24">
                <path
                  fill-rule="evenodd"
                  d="M6.75 2.25A.75.75 0 0 1 7.5 3v1.5h9V3A.75.75 0 0 1 18 3v1.5h.75a3 3 0 0 1 3 3v11.25a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3V7.5a3 3 0 0 1 3-3H6V3a.75.75 0 0 1 .75-.75Zm13.5 9a1.5 1.5 0 0 0-1.5-1.5H5.25a1.5 1.5 0 0 0-1.5 1.5v7.5a1.5 1.5 0 0 0 1.5 1.5h13.5a1.5 1.5 0 0 0 1.5-1.5v-7.5Z"
                  clip-rule="evenodd"
                />
              </svg>
              Classes
              <span
                class="tab-eye-btn"
                onclick="
                  event.stopPropagation();
                  toggleTabEye('classes');
                "
                title="Toggle visibility"
                ><svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
                  <path
                    fill-rule="evenodd"
                    d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.224-10.676-7.69a1.762 1.762 0 0 1 0-1.113ZM17.25 12a5.25 5.25 0 1 1-10.5 0 5.25 5.25 0 0 1 10.5 0Z"
                    clip-rule="evenodd"
                  /></svg
              ></span>
            </button>
          </div>
        </aside>
        <main class="main-panel">
          <div id="welcome-panel" class="panel active">
            <div class="welcome-content">
              <svg
                viewBox="-2 -2 100 114"
                width="48"
                height="52"
                fill="none"
                style="stroke: var(--text-muted)"
              >
                <path
                  d="M10,6 L48,6 L58,16 L58,38 L48,48 L58,58 L58,84 L48,96 L10,96 Z"
                  stroke="currentColor"
                  stroke-width="2.5"
                  fill="none"
                  stroke-linejoin="miter"
                  stroke-linecap="butt"
                />
                <line
                  x1="10"
                  y1="48"
                  x2="48"
                  y2="48"
                  stroke="currentColor"
                  stroke-width="2.5"
                />
                <polyline
                  points="70,4 70,70 48,96 92,96"
                  stroke="currentColor"
                  stroke-width="2.5"
                  fill="none"
                  stroke-linejoin="miter"
                  stroke-linecap="butt"
                />
              </svg>
              <h2>Welcome</h2>
              <p id="welcome-message">
                <span
                  id="welcome-name-display"
                  style="cursor: pointer"
                  onclick="editWelcomeName()"
                ></span>
              </p>
            </div>
          </div>
          <div id="diagnostics-panel" class="panel">
            <div id="diagnostics-list" class="items-list">
              <div class="add-item-card">
                <button id="add-diagnostic-btn" class="btn-small">
                  + Assign
                </button>
              </div>
              <div class="empty-state">No diagnostics assigned</div>
            </div>
          </div>
          <div id="games-panel" class="panel">
            <div id="games-list" class="items-list">
              <div class="add-item-card">
                <button id="add-game-btn" class="btn-small">+ Add Game</button>
              </div>
              <div class="empty-state">No games assigned</div>
            </div>
          </div>
          <div id="tests-panel" class="panel">
            <div id="tests-list" class="items-list">
              <div class="add-item-card">
                <button id="add-test-btn" class="btn-small">+ Add Test</button>
              </div>
              <div class="empty-state">No tests assigned</div>
            </div>
          </div>
          <div id="links-panel" class="panel">
            <div id="links-list" class="items-list">
              <div class="add-item-card">
                <button id="add-link-btn" class="btn-small">+ Add Link</button>
              </div>
              <div class="empty-state">No links saved</div>
            </div>
          </div>
          <div id="progress-panel" class="panel">
            <div id="progress-list" class="items-list">
              <div class="add-item-card">
                <button id="add-progress-btn" class="btn-small">
                  + Add Topic
                </button>
              </div>
              <div class="empty-state">No progress tracked</div>
            </div>
          </div>
          <div id="classlog-panel" class="panel">
            <div id="classlog-list" class="items-list">
              <div class="add-item-card">
                <button id="add-classlog-btn" class="btn-small">
                  + Add Entry
                </button>
              </div>
              <div class="empty-state">No class log entries yet</div>
            </div>
          </div>
          <div id="vocab-panel" class="panel">
            <div class="search-bar" id="vocab-search">
              <svg viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
              </svg>
              <input
                type="text"
                placeholder="Search vocabulary..."
                oninput="filterVocab(this.value)"
              />
            </div>
            <div id="vocab-list" class="items-list">
              <div class="add-item-card">
                <button id="add-vocab-btn" class="btn-small">+ Add Word</button>
              </div>
              <div class="empty-state">No vocabulary words yet</div>
            </div>
          </div>
          <div id="homework-panel" class="panel">
            <div id="homework-list" class="items-list">
              <div class="add-item-card">
                <button id="add-homework-btn" class="btn-small">
                  + Add Assignment
                </button>
              </div>
              <div class="empty-state">No homework assigned</div>
            </div>
          </div>
          <div id="planner-panel" class="panel">
            <div
              id="planner-header"
              style="
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 16px;
              "
            >
              <button class="btn-small" id="planner-prev">&larr; Prev</button>
              <h3
                id="planner-month"
                style="font-size: 16px; font-weight: 600"
              ></h3>
              <button class="btn-small" id="planner-next">Next &rarr;</button>
            </div>
            <div id="planner-calendar" class="planner-week"></div>
            <div style="margin-top: 16px">
              <div class="add-item-card">
                <button id="add-lesson-btn" class="btn-small">
                  + Add Lesson
                </button>
              </div>
              <div id="planner-lessons"></div>
              <div class="empty-state" id="planner-empty">
                No lessons planned this week
              </div>
            </div>
          </div>
          <div id="classbook-panel" class="panel">
            <div class="search-bar" id="classbook-search">
              <svg viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
              </svg>
              <input
                type="text"
                placeholder="Search resources..."
                oninput="filterClassBook(this.value)"
              />
            </div>
            <div id="classbook-list" class="items-list">
              <div class="add-item-card">
                <button id="add-classbook-btn" class="btn-small">
                  + Add Resource
                </button>
              </div>
              <div class="empty-state">No class book resources yet</div>
            </div>
          </div>
          <div id="classes-panel" class="panel">
            <div class="classes-subnav" id="classes-subnav">
              <button
                class="classes-subnav-btn active"
                data-view="next"
                onclick="switchClassView('next')"
              >
                <span class="subnav-emoji">📌</span>Next Class
              </button>
              <button
                class="classes-subnav-btn"
                data-view="previous"
                onclick="switchClassView('previous')"
              >
                <span class="subnav-emoji">📋</span>Previous
              </button>
              <button
                class="classes-subnav-btn"
                data-view="future"
                onclick="switchClassView('future')"
              >
                <span class="subnav-emoji">📅</span>Future
              </button>
            </div>
            <div
              id="classes-add-row"
              class="add-item-card"
              style="margin-bottom: 12px"
            >
              <button
                id="add-class-btn"
                class="btn-small"
                onclick="openAddClass()"
              >
                + Schedule Class
              </button>
            </div>
            <div id="classes-content"></div>
          </div>
        </main>
      </div>
    </div>

    <!-- Class Timer Widget -->
    <div id="timer-widget" class="timer-widget">
      <div id="timer-panel" class="timer-panel">
        <div class="timer-display" id="timer-display">00:00</div>
        <div class="timer-controls">
          <button class="timer-btn primary" id="timer-start">Start</button>
          <button class="timer-btn" id="timer-reset">Reset</button>
        </div>
        <div class="timer-presets">
          <button class="timer-preset" onclick="setTimer(5)">5m</button>
          <button class="timer-preset" onclick="setTimer(10)">10m</button>
          <button class="timer-preset" onclick="setTimer(15)">15m</button>
          <button class="timer-preset" onclick="setTimer(25)">25m</button>
          <button class="timer-preset" onclick="setTimer(45)">45m</button>
        </div>
      </div>
      <button class="timer-fab" id="timer-fab" onclick="toggleTimerPanel()">
        <svg id="timer-fab-icon" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10" />
          <polyline points="12 6 12 12 16 14" />
        </svg>
        <span
          id="timer-fab-time"
          class="timer-fab-time"
          style="display: none"
        ></span>
      </button>
    </div>

    <!-- Profile Edit Modal -->
    <div
      id="profile-overlay"
      class="profile-overlay"
      onclick="if (event.target === this) closeProfile();"
    >
      <div class="profile-card">
        <div class="profile-avatar-wrapper" onclick="pickProfilePhoto()">
          <div id="profile-avatar" class="profile-avatar-lg"></div>
          <div class="profile-avatar-edit">📷 Change</div>
        </div>
        <input
          type="file"
          id="profile-photo-input"
          accept="image/*"
          style="display: none"
        />
        <input
          id="profile-display-name"
          class="profile-name-input"
          placeholder="Display Name"
          maxlength="30"
        />
        <div class="profile-meta" id="profile-role-label"></div>
        <div class="profile-field" id="profile-email-field">
          <label>Email</label>
          <input
            id="profile-email"
            type="email"
            placeholder="email@example.com"
          />
        </div>
        <div
          class="profile-field"
          id="profile-level-field"
          style="display: none"
        >
          <label>Level</label>
          <select id="profile-level">
            <option value="A0">A0 – Beginner</option>
            <option value="A1">A1 – Elementary</option>
            <option value="A2">A2 – Pre-Intermediate</option>
            <option value="B1">B1 – Intermediate</option>
            <option value="B2">B2 – Upper-Intermediate</option>
          </select>
        </div>
        <div class="profile-field" id="profile-bio-field">
          <label>About</label>
          <input
            id="profile-bio"
            type="text"
            placeholder="A short bio…"
            maxlength="100"
          />
        </div>
        <div class="profile-actions">
          <button class="profile-btn-cancel" onclick="closeProfile()">
            Cancel
          </button>
          <button class="profile-btn-save" onclick="saveProfile()">
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div id="modal-overlay" class="modal-overlay hidden">
      <div class="modal">
        <div class="modal-header">
          <h3 id="modal-title">Modal</h3>
          <button class="modal-close" id="modal-close-btn">
            <svg viewBox="0 0 24 24">
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>
        <div id="modal-content" class="modal-content"></div>
      </div>
    </div>

    <!-- Full-screen Diagnostic Assessment -->
    <div id="diag-overlay" class="diag-overlay">
      <div class="diag-header">
        <h2 id="diag-title">Assessment</h2>
        <button class="diag-close" id="diag-close-btn">
          <svg viewBox="0 0 24 24">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
      </div>
      <div class="diag-progress">
        <div class="diag-progress-bar">
          <div class="diag-progress-fill" id="diag-progress-fill"></div>
        </div>
        <div class="diag-progress-text" id="diag-progress-text">
          Section 1 of 15
        </div>
      </div>
      <div class="diag-body">
        <div class="diag-sidebar">
          <div class="diag-section-nav" id="diag-section-nav"></div>
        </div>
        <div class="diag-main">
          <div class="diag-content" id="diag-content"></div>
          <div class="diag-footer">
            <button class="diag-nav-btn prev" id="diag-prev-btn">
              &larr; Previous
            </button>
            <button class="diag-nav-btn next" id="diag-next-btn">
              Next &rarr;
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
      // SVG icon helpers
      var SVG = {
        check:
          '<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
        x: '<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
        tilde:
          '<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2"><path d="M3 12c2-4 5-4 7 0s5 4 7 0"/></svg>',
        trash:
          '<svg viewBox="0 0 24 24" width="12" height="12" stroke="currentColor" fill="none" stroke-width="1.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
        key: '<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="1.5"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>',
        play: '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="1.5"><polygon points="5 3 19 12 5 21 5 3"/></svg>',
        doc: '<svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
        game: '<svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none" stroke-width="1.5"><rect x="2" y="6" width="20" height="12" rx="2"/><circle cx="12" cy="12" r="2"/></svg>',
        calendar:
          '<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
        clock:
          '<svg viewBox="0 0 24 24" width="12" height="12" stroke="currentColor" fill="none" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
        chat: '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
        edit: '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="1.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
        bulb: '<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="1.5"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 1 1 7.072 0l-.548.547A3.374 3.374 0 0 0 14 18.469V19a2 2 0 1 1-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>',
        muscle:
          '<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="1.5"><path d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z"/></svg>',
        trending:
          '<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="1.5"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
        chart:
          '<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="1.5"><path d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125z"/></svg>',
        warn: '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="1.5"><path d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0zm-9 3.75h.008v.008H12v-.008z"/></svg>',
        circle:
          '<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>',
        diamond:
          '<svg viewBox="0 0 24 24" width="16" height="16" stroke="var(--yellow)" fill="none" stroke-width="2"><path d="M12 2l10 10-10 10L2 12z"/></svg>',
        homework:
          '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="1.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
        search:
          '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
        download:
          '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
        grip: '<svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor" stroke="none"><circle cx="9" cy="6" r="1.5"/><circle cx="15" cy="6" r="1.5"/><circle cx="9" cy="12" r="1.5"/><circle cx="15" cy="12" r="1.5"/><circle cx="9" cy="18" r="1.5"/><circle cx="15" cy="18" r="1.5"/></svg>',
        camera:
          '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="1.5"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>',
        star: '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="1.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
      };

      // Firebase config
      var firebaseConfig = {
        apiKey: "AIzaSyAki3QaFgKY0cTWAt2R06c86WimoXRVWKs",
        authDomain: "lessonsplatform-e228c.firebaseapp.com",
        projectId: "lessonsplatform-e228c",
        storageBucket: "lessonsplatform-e228c.firebasestorage.app",
        messagingSenderId: "804556322280",
        appId: "1:804556322280:web:85ffeb6fd6a49e321c605d",
      };
      firebase.initializeApp(firebaseConfig);
      var db = firebase.firestore();

      // Users
      var USERS = {
        tomas: { password: "admin123", role: "admin", name: "Tomas" },
        leo: {
          password: "leo123",
          role: "student",
          name: "Leo",
          studentId: "c2PmfTNfEwbcqJtk0xiU",
        },
        george: { password: "georgept2026", role: "student", name: "George" },
      };

      var currentUser = null;
      var selectedStudent = null;

      // Remember Me: restore saved credentials on load and auto-login
      (function () {
        var saved = localStorage.getItem("bl_remember");
        if (saved) {
          try {
            var creds = JSON.parse(saved);
            var u = creds.u || "";
            var p = creds.p || "";
            document.getElementById("username").value = u;
            document.getElementById("password").value = p;
            document.getElementById("remember-me").checked = true;
            // Auto-login with loading overlay
            if (u && p) {
              var savedHeaderName = localStorage.getItem("bl_header_name_" + u);
              var displayName = savedHeaderName || u;
              document.getElementById("loading-user-name").textContent =
                displayName;
              var overlay = document.getElementById("loading-overlay");
              overlay.classList.add("visible");

              setTimeout(function () {
                document
                  .getElementById("login-form")
                  .dispatchEvent(new Event("submit"));
                setTimeout(function () {
                  overlay.classList.add("fade-out");
                  setTimeout(function () {
                    overlay.classList.remove("visible", "fade-out");
                  }, 500);
                }, 4000);
              }, 100);
            }
          } catch (e) {}
        }
      })();

      // Login
      document.getElementById("login-form").onsubmit = function (e) {
        e.preventDefault();
        var username = document
          .getElementById("username")
          .value.trim()
          .toLowerCase();
        var password = document.getElementById("password").value;
        var errorDiv = document.getElementById("login-error");
        var signInBtn = document.getElementById("sign-in-btn");

        errorDiv.classList.remove("show");
        signInBtn.classList.add("loading");

        function onLoginDone() {
          signInBtn.classList.remove("loading");
        }

        function saveRemember(u, p) {
          if (document.getElementById("remember-me").checked) {
            localStorage.setItem("bl_remember", JSON.stringify({ u: u, p: p }));
          } else {
            localStorage.removeItem("bl_remember");
          }
        }

        if (USERS[username] && USERS[username].password === password) {
          saveRemember(username, password);
          onLoginDone();
          loginSuccess(username, USERS[username]);
          return;
        }

        db.collection("students")
          .where("username", "==", username)
          .get()
          .then(function (snap) {
            if (!snap.empty) {
              var studentDoc = snap.docs[0];
              var student = studentDoc.data();
              if (student.password === password) {
                USERS[username] = {
                  password: password,
                  role: "student",
                  name: student.name,
                  studentId: studentDoc.id,
                };
                saveRemember(username, password);
                onLoginDone();
                loginSuccess(username, USERS[username]);
                return;
              }
            }
            onLoginDone();
            errorDiv.textContent = "Invalid username or password";
            errorDiv.classList.add("show");
          })
          .catch(function (err) {
            onLoginDone();
            errorDiv.textContent = "Login error: " + err.message;
            errorDiv.classList.add("show");
          });
      };

      function loginSuccess(username, userData) {
        currentUser = {
          username: username,
          password: userData.password,
          role: userData.role,
          name: userData.name,
          displayName: userData.displayName || userData.name.split(" ")[0],
        };
        document.body.className = "dashboard-view";
        document.getElementById("login-screen").classList.add("hidden");
        document.getElementById("dashboard-screen").classList.add("active");
        document.getElementById("current-user-name").textContent =
          currentUser.name;
        document.getElementById("user-role-badge").textContent =
          currentUser.role;
        document.getElementById("welcome-name-display").textContent =
          currentUser.displayName;
        document.getElementById("login-error").classList.remove("show");
        if (currentUser.role === "admin") {
          document.getElementById("admin-panel").classList.remove("hidden");
          loadStudents();
        } else {
          document.getElementById("admin-panel").classList.add("hidden");
          document.getElementById("student-nav").classList.remove("hidden");
          loadStudentDataByName(currentUser.name);
        }
      }

      // Logout
      document.getElementById("logout-btn").onclick = function () {
        currentUser = null;
        selectedStudent = null;
        document.body.className = "login-view";
        document.getElementById("login-screen").classList.remove("hidden");
        document.getElementById("dashboard-screen").classList.remove("active");
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
        document.getElementById("login-error").classList.remove("show");
      };

      // Students toggle
      document.getElementById("students-toggle").onclick = function () {
        this.classList.toggle("open");
        document.getElementById("students-content").classList.toggle("open");
      };

      // Edit welcome name
      function editWelcomeName() {
        var newName = prompt(
          "What name would you like to be greeted with?",
          currentUser.displayName,
        );
        if (newName && newName.trim()) {
          currentUser.displayName = newName.trim();
          document.getElementById("welcome-name-display").textContent =
            currentUser.displayName;
          // Save to Firebase
          if (currentUser.role === "student") {
            db.collection("students")
              .where("name", "==", currentUser.name)
              .get()
              .then(function (snap) {
                if (!snap.empty) {
                  snap.docs[0].ref.update({
                    displayName: currentUser.displayName,
                  });
                }
              });
          } else {
            // For admin, save to localStorage or Firebase users
            localStorage.setItem(
              "bl_display_name_" + currentUser.username,
              currentUser.displayName,
            );
          }
        }
      }

      // Theme toggle
      function toggleTheme() {
        var html = document.documentElement;
        var current = html.getAttribute("data-theme");
        var newTheme = current === "light" ? "dark" : "light";
        if (newTheme === "dark") {
          html.removeAttribute("data-theme");
        } else {
          html.setAttribute("data-theme", newTheme);
        }
        localStorage.setItem("bl_theme", newTheme);
        updateThemeIcon(newTheme);
      }
      function updateThemeIcon(theme) {
        var moon = document.getElementById("theme-icon-moon");
        var sun = document.getElementById("theme-icon-sun");
        if (moon && sun) {
          if (theme === "light") {
            moon.style.display = "none";
            sun.style.display = "block";
          } else {
            moon.style.display = "block";
            sun.style.display = "none";
          }
        }
      }
      // Restore saved theme or detect system preference
      (function () {
        var saved = localStorage.getItem("bl_theme");
        var isLight =
          saved === "light" ||
          (!saved &&
            window.matchMedia &&
            window.matchMedia("(prefers-color-scheme: light)").matches);
        if (isLight) {
          document.documentElement.setAttribute("data-theme", "light");
          updateThemeIcon("light");
        }
      })();

      // Edit header name
      function editHeaderName() {
        var span = document.getElementById("current-user-name");
        var original = span.textContent;
        span.contentEditable = "true";
        span.focus();
        // Select all text
        var range = document.createRange();
        range.selectNodeContents(span);
        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        span.style.outline = "none";
        span.style.borderBottom = "1px solid var(--text-muted)";
        span.style.paddingBottom = "2px";

        function finishEdit() {
          span.contentEditable = "false";
          span.style.borderBottom = "none";
          span.style.paddingBottom = "0";
          var newName = span.textContent.trim();
          if (newName && newName !== original) {
            currentUser.name = newName;
            localStorage.setItem(
              "bl_header_name_" + currentUser.username,
              newName,
            );
          } else {
            span.textContent = original;
          }
          span.removeEventListener("blur", finishEdit);
          span.removeEventListener("keydown", onKey);
        }
        function onKey(e) {
          if (e.key === "Enter") {
            e.preventDefault();
            span.blur();
          } else if (e.key === "Escape") {
            span.textContent = original;
            span.blur();
          }
        }
        span.addEventListener("blur", finishEdit);
        span.addEventListener("keydown", onKey);
      }

      // Load Students
      function loadStudents() {
        var list = document.getElementById("student-list");
        db.collection("students")
          .get()
          .then(function (snapshot) {
            if (snapshot.empty) {
              list.innerHTML = '<div class="empty-state">No students yet</div>';
              return;
            }
            list.innerHTML = "";
            snapshot.forEach(function (doc) {
              var student = doc.data();
              var div = document.createElement("div");
              div.className = "student-item";
              div.innerHTML =
                '<div class="student-avatar">' +
                student.name.charAt(0).toUpperCase() +
                '</div><div class="student-info"><div class="name">' +
                student.name +
                '</div><div class="meta">' +
                (student.level || "A0") +
                (student.username ? " &middot; @" + student.username : "") +
                "</div></div>";
              div.onclick = function () {
                selectedStudent = {
                  id: doc.id,
                  name: student.name,
                  level: student.level,
                };
                document
                  .querySelectorAll(".student-item")
                  .forEach(function (el) {
                    el.classList.remove("active");
                  });
                div.classList.add("active");
                document
                  .getElementById("student-nav")
                  .classList.remove("hidden");
                // Keep the currently active tab (or default to diagnostics)
                var activeTab = document.querySelector(".nav-tab.active");
                var currentTab = activeTab
                  ? activeTab.dataset.tab
                  : "diagnostics";
                showPanel(currentTab);
                loadStudentData();
                // Apply tab visibility for this student
                applyTabVisibility(student.name);
              };
              list.appendChild(div);
            });
            document.getElementById("students-toggle").classList.add("open");
            document.getElementById("students-content").classList.add("open");
          })
          .catch(function (e) {
            list.innerHTML =
              '<div class="empty-state">Error loading: ' + e.message + "</div>";
          });
      }

      // Tab Navigation
      document.querySelectorAll(".nav-tab").forEach(function (tab) {
        tab.onclick = function () {
          document.querySelectorAll(".nav-tab").forEach(function (t) {
            t.classList.remove("active");
          });
          this.classList.add("active");
          showPanel(this.dataset.tab);
        };
      });

      function showPanel(name) {
        document.querySelectorAll(".panel").forEach(function (p) {
          p.classList.remove("active");
        });
        document.getElementById(name + "-panel").classList.add("active");
      }

      function generateUsername(name) {
        return (
          name.toLowerCase().replace(/[^a-z0-9]/g, "") +
          Math.floor(Math.random() * 100)
        );
      }
      function generatePassword() {
        var chars = "abcdefghijklmnopqrstuvwxyz0123456789";
        var pass = "";
        for (var i = 0; i < 8; i++)
          pass += chars.charAt(Math.floor(Math.random() * chars.length));
        return pass;
      }

      // Add Student
      document.getElementById("add-student-btn").onclick = function () {
        openModal(
          "Add New Student",
          '<form id="student-form"><div class="form-group"><label>Student Name</label><input type="text" id="new-student-name" name="name" required placeholder="Enter student\'s name"></div><div class="form-group"><label>Level</label><select name="level"><option value="A0">A0 - Beginner</option><option value="A1">A1 - Elementary</option><option value="A2">A2 - Pre-Intermediate</option><option value="B1">B1 - Intermediate</option><option value="B2">B2 - Upper-Intermediate</option></select></div><div id="credentials-preview" style="display:none"></div><button type="submit" class="btn">Create Student Account</button></form>',
        );

        document.getElementById("new-student-name").oninput = function () {
          var name = this.value.trim();
          if (name.length >= 2) {
            var username = generateUsername(name);
            var password = generatePassword();
            document.getElementById("credentials-preview").innerHTML =
              '<div class="credentials-box"><h4>' +
              SVG.key +
              ' Auto-Generated Credentials</h4><div class="credentials-item"><label>Username:</label><span id="gen-username">' +
              username +
              '</span></div><div class="credentials-item"><label>Password:</label><span id="gen-password">' +
              password +
              '</span></div><p style="font-size:11px;color:var(--text-muted);margin-top:12px">Save these credentials. They will be shown once after creation.</p></div>';
            document.getElementById("credentials-preview").style.display =
              "block";
          } else {
            document.getElementById("credentials-preview").style.display =
              "none";
          }
        };

        document.getElementById("student-form").onsubmit = function (e) {
          e.preventDefault();
          var form = new FormData(this);
          var name = form.get("name");
          var username = document.getElementById("gen-username").textContent;
          var password = document.getElementById("gen-password").textContent;

          db.collection("students")
            .add({
              name: name,
              level: form.get("level"),
              username: username,
              password: password,
              createdAt: new Date(),
            })
            .then(function (docRef) {
              USERS[username] = {
                password: password,
                role: "student",
                name: name,
                studentId: docRef.id,
              };
              document.getElementById("modal-content").innerHTML =
                '<div style="text-align:center;padding:20px"><div style="margin-bottom:16px;color:var(--green)">' +
                SVG.check +
                '</div><h3 style="margin-bottom:16px">Student Created</h3><div class="credentials-box"><h4>' +
                SVG.key +
                ' Login Credentials</h4><div class="credentials-item"><label>Username:</label><span>' +
                username +
                '</span></div><div class="credentials-item"><label>Password:</label><span>' +
                password +
                '</span></div></div><p style="margin-top:16px;color:var(--red);font-size:13px;display:flex;align-items:center;gap:6px;justify-content:center">' +
                SVG.warn +
                ' Save these credentials now.</p><button class="btn" style="margin-top:20px" onclick="closeModal(); loadStudents();">Done</button></div>';
            })
            .catch(function (e) {
              alert("Error: " + e.message);
            });
        };
      };

      function loadStudentDataByName(name) {
        db.collection("students")
          .where("name", "==", name)
          .get()
          .then(function (snap) {
            if (!snap.empty) {
              var doc = snap.docs[0];
              selectedStudent = {
                id: doc.id,
                name: doc.data().name,
                level: doc.data().level,
              };
              applyTabVisibility(selectedStudent.name);
              // Show first visible tab
              var firstVisible = document.querySelector(
                "#student-nav .nav-tab:not([style*='display: none'])",
              );
              if (firstVisible) {
                document.querySelectorAll(".nav-tab").forEach(function (t) {
                  t.classList.remove("active");
                });
                firstVisible.classList.add("active");
                showPanel(firstVisible.dataset.tab);
              } else {
                showPanel("diagnostics");
              }
              loadStudentData();
            }
          });
      }

      function loadStudentData() {
        if (!selectedStudent) return;
        loadDiagnostics();
        loadClassLog();
        loadClasses();

        var isAdmin = currentUser && currentUser.role === "admin";
        ["games", "tests", "links", "progress"].forEach(function (tab) {
          db.collection("students")
            .doc(selectedStudent.id)
            .collection(tab)
            .orderBy("createdAt", "desc")
            .get()
            .then(function (snap) {
              var list = document.getElementById(tab + "-list");
              // Keep the add button, only replace items after it
              if (snap.empty) {
                while (list.children.length > 1) {
                  list.removeChild(list.lastChild);
                }
              } else {
                // Remove old items but keep add button
                while (list.children.length > 1) {
                  list.removeChild(list.lastChild);
                }
                var activeCards = [];
                var completedCards = [];
                snap.forEach(function (doc) {
                  var item = doc.data();
                  var deleteBtn = isAdmin
                    ? '<button class="delete-btn" onclick="deleteItem(\'' +
                      tab +
                      "', '" +
                      doc.id +
                      "')\">" +
                      SVG.trash +
                      " Delete</button>"
                    : "";
                  if (tab === "games") {
                    var card = document.createElement("div");
                    card.className =
                      "item-card" + (item.completed ? " game-completed" : "");
                    card.setAttribute(
                      "data-game-status",
                      item.completed ? "completed" : "active",
                    );
                    var completeBtn = isAdmin
                      ? '<button class="btn-small" style="font-size:11px;padding:4px 10px;" onclick="toggleGameComplete(\'' +
                        doc.id +
                        "'," +
                        !!item.completed +
                        ')">' +
                        (item.completed ? "↩ Reopen" : "✅ Done") +
                        "</button>"
                      : "";
                    card.innerHTML =
                      '<div class="item-content"><div class="item-title">' +
                      (item.completed
                        ? '<span style="opacity:0.5">✅ </span>'
                        : "🎮 ") +
                      (item.title || "Game") +
                      '</div><div class="item-desc">' +
                      (item.description || "") +
                      '</div><div class="item-actions"><a href="' +
                      item.url +
                      '" target="_blank" class="btn-small" style="text-decoration:none">' +
                      SVG.play +
                      " Play Game</a>" +
                      completeBtn +
                      deleteBtn +
                      "</div></div>";
                    if (item.completed) {
                      completedCards.push(card);
                    } else {
                      activeCards.push(card);
                    }
                  } else {
                    var card = document.createElement("div");
                    card.className = "item-card";
                    card.innerHTML =
                      '<div class="item-content"><div class="item-title">' +
                      (item.title || "Untitled") +
                      '</div><div class="item-desc">' +
                      (item.description || item.url || "") +
                      '</div><div class="item-actions">' +
                      (item.status
                        ? '<span class="status-badge ' +
                          item.status +
                          '">' +
                          item.status +
                          "</span>"
                        : "") +
                      deleteBtn +
                      "</div></div>";
                    list.appendChild(card);
                  }
                });
                // Insert section dividers for games tab
                if (
                  tab === "games" &&
                  (activeCards.length || completedCards.length)
                ) {
                  if (activeCards.length) {
                    var activeLabel = document.createElement("div");
                    activeLabel.className = "games-section-label";
                    activeLabel.innerHTML =
                      "🎮 Active Games <span style='font-size:12px;opacity:0.5;font-weight:400'>(" +
                      activeCards.length +
                      ")</span>";
                    list.appendChild(activeLabel);
                    activeCards.forEach(function (c) {
                      list.appendChild(c);
                    });
                  }
                  if (completedCards.length) {
                    var completedLabel = document.createElement("div");
                    completedLabel.className = "games-section-label";
                    completedLabel.innerHTML =
                      "📁 Completed Games <span style='font-size:12px;opacity:0.5;font-weight:400'>(" +
                      completedCards.length +
                      ")</span>";
                    list.appendChild(completedLabel);
                    completedCards.forEach(function (c) {
                      list.appendChild(c);
                    });
                  }
                }
              }
            });
        });
      }

      function loadDiagnostics() {
        var list = document.getElementById("diagnostics-list");
        var isAdmin = currentUser && currentUser.role === "admin";
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("diagnostics")
          .orderBy("createdAt", "desc")
          .get()
          .then(function (snap) {
            // Keep the add button, only replace items after it
            var addCard = list.querySelector(".add-item-card");
            if (snap.empty) {
              // Keep add button, remove everything else
              while (list.children.length > 1) {
                list.removeChild(list.lastChild);
              }
              return;
            }
            // Remove old items but keep add button
            while (list.children.length > 1) {
              list.removeChild(list.lastChild);
            }
            snap.forEach(function (doc) {
              var item = doc.data();
              var statusClass =
                item.status === "completed" ? "completed" : "pending";
              var actionBtn = "";
              if (item.sections && item.status !== "completed") {
                actionBtn =
                  "<button onclick=\"openDiagnosticForm('" +
                  doc.id +
                  '\')" class="btn-small">' +
                  SVG.edit +
                  " Fill Out</button>";
              } else if (item.sections && item.status === "completed") {
                actionBtn =
                  "<button onclick=\"viewDiagnosticResults('" +
                  doc.id +
                  '\')" class="btn-small">' +
                  SVG.check +
                  " View Results</button>";
              }
              var deleteBtn = isAdmin
                ? "<button class=\"delete-btn\" onclick=\"deleteItem('diagnostics', '" +
                  doc.id +
                  "')\">" +
                  SVG.trash +
                  " Delete</button>"
                : "";
              var card = document.createElement("div");
              card.className = "item-card";
              card.innerHTML =
                '<div class="item-content"><div class="item-title">' +
                (item.title || "Diagnostic") +
                '</div><div class="item-desc">' +
                (item.description || "") +
                '</div><div class="item-actions"><span class="status-badge ' +
                statusClass +
                '">' +
                item.status +
                "</span>" +
                actionBtn +
                deleteBtn +
                "</div></div>";
              list.appendChild(card);
            });
          });
      }

      var currentDiag = null;
      var currentDiagId = null;
      var currentSection = 0;

      function openDiagnosticForm(diagId) {
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("diagnostics")
          .doc(diagId)
          .get()
          .then(function (doc) {
            var diag = doc.data();
            if (!diag.sections) {
              alert("This diagnostic does not have an interactive form");
              return;
            }
            currentDiag = diag;
            currentDiagId = diagId;
            currentSection = 0;
            document.getElementById("diag-title").textContent = diag.title;
            document.getElementById("diag-overlay").classList.add("active");
            renderSectionNav();
            renderSection(0);
          });
      }

      function renderSectionNav() {
        var nav = document.getElementById("diag-section-nav");
        nav.innerHTML = "";
        currentDiag.sections.forEach(function (section, i) {
          var completed = isSectionCompleted(section);
          var btn = document.createElement("button");
          btn.className =
            "diag-section-btn" +
            (i === currentSection ? " active" : "") +
            (completed ? " completed" : "");
          btn.innerHTML =
            '<span style="font-size:18px">' +
            section.title.split(" ")[0] +
            '</span><span style="flex:1">' +
            section.title.split(" ").slice(1).join(" ") +
            "</span>" +
            (completed ? '<span class="check">' + SVG.check + "</span>" : "");
          btn.onclick = function () {
            goToSection(i);
          };
          nav.appendChild(btn);
        });
      }

      function isSectionCompleted(section) {
        return section.items.every(function (item) {
          return item.response !== "" && item.response !== undefined;
        });
      }

      function countAnswered() {
        var total = 0,
          answered = 0;
        currentDiag.sections.forEach(function (s) {
          s.items.forEach(function (item) {
            total++;
            if (item.response && item.response !== "") answered++;
          });
        });
        return { total: total, answered: answered };
      }

      function updateProgress() {
        var counts = countAnswered();
        var pct = Math.round((counts.answered / counts.total) * 100);
        document.getElementById("diag-progress-fill").style.width = pct + "%";
        document.getElementById("diag-progress-text").textContent =
          "Section " +
          (currentSection + 1) +
          " of " +
          currentDiag.sections.length +
          " \u2022 " +
          counts.answered +
          "/" +
          counts.total +
          " answered";
      }

      function goToSection(index) {
        currentSection = index;
        renderSection(index);
        renderSectionNav();
      }

      function renderSection(index) {
        var section = currentDiag.sections[index];
        var content = document.getElementById("diag-content");
        var isLastSection = index === currentDiag.sections.length - 1;
        var html = '<div class="diag-section-header">';
        html +=
          '<span class="category">' +
          (section.category || "Vocabulary") +
          "</span>";
        html += "<h3>" + section.title + "</h3>";
        html += '<p class="instruction">' + section.instruction + "</p>";
        if (section.tip)
          html +=
            '<div class="tip">' +
            SVG.bulb +
            " <span><strong>Tip:</strong> " +
            section.tip +
            "</span></div>";
        html += '</div><div class="diag-items">';
        section.items.forEach(function (item, ii) {
          var answered = item.response && item.response !== "";
          html +=
            '<div class="diag-item' + (answered ? " answered" : "") + '">';
          html += '<div class="diag-item-emoji">' + item.emoji + "</div>";
          html +=
            '<div class="diag-item-text"><div class="diag-item-pt">' +
            item.portuguese +
            '</div><div class="diag-item-en">' +
            item.english +
            "</div></div>";
          html += '<div class="diag-item-btns">';
          html +=
            '<button class="diag-item-btn' +
            (item.response === "correct" ? " correct selected" : "") +
            '" data-val="correct" data-section="' +
            index +
            '" data-item="' +
            ii +
            '" title="Correct">' +
            SVG.check +
            "</button>";
          html +=
            '<button class="diag-item-btn' +
            (item.response === "partial" ? " partial selected" : "") +
            '" data-val="partial" data-section="' +
            index +
            '" data-item="' +
            ii +
            '" title="Partial">' +
            SVG.tilde +
            "</button>";
          html +=
            '<button class="diag-item-btn' +
            (item.response === "none" ? " none selected" : "") +
            '" data-val="none" data-section="' +
            index +
            '" data-item="' +
            ii +
            '" title="No Response">' +
            SVG.x +
            "</button>";
          html += "</div></div>";
        });
        html += "</div>";
        if (isLastSection) {
          html +=
            '<div class="diag-notes" style="margin-top:32px"><label>' +
            SVG.edit +
            ' Parent Notes & Observations</label><textarea id="parent-notes" placeholder="Share any observations...">' +
            (currentDiag.parentNotes || "") +
            "</textarea></div>";
          html +=
            '<div class="diag-notes"><label>' +
            SVG.muscle +
            ' Child\'s Strengths</label><textarea id="child-strengths" placeholder="What did your child do well?">' +
            (currentDiag.childStrengths || "") +
            "</textarea></div>";
          html +=
            '<div class="diag-notes"><label>' +
            SVG.trending +
            ' Areas for Improvement</label><textarea id="areas-improvement" placeholder="What areas need more practice?">' +
            (currentDiag.areasForImprovement || "") +
            "</textarea></div>";
        }
        content.innerHTML = html;
        content.querySelectorAll(".diag-item-btn").forEach(function (btn) {
          btn.onclick = function () {
            var si = parseInt(this.dataset.section),
              ii = parseInt(this.dataset.item),
              val = this.dataset.val;
            currentDiag.sections[si].items[ii].response = val;
            this.parentNode
              .querySelectorAll(".diag-item-btn")
              .forEach(function (b) {
                b.classList.remove("selected", "correct", "partial", "none");
              });
            this.classList.add("selected", val);
            this.closest(".diag-item").classList.add("answered");
            updateProgress();
            renderSectionNav();
          };
        });
        document.getElementById("diag-prev-btn").disabled = index === 0;
        var nextBtn = document.getElementById("diag-next-btn");
        if (isLastSection) {
          nextBtn.innerHTML = SVG.check + " Submit Assessment";
          nextBtn.className = "diag-nav-btn finish";
        } else {
          nextBtn.innerHTML = "Next &rarr;";
          nextBtn.className = "diag-nav-btn next";
        }
        updateProgress();
      }

      document.getElementById("diag-prev-btn").onclick = function () {
        if (currentSection > 0) goToSection(currentSection - 1);
      };
      document.getElementById("diag-next-btn").onclick = function () {
        if (currentSection === currentDiag.sections.length - 1) {
          var n = document.getElementById("parent-notes"),
            s = document.getElementById("child-strengths"),
            im = document.getElementById("areas-improvement");
          if (n) currentDiag.parentNotes = n.value;
          if (s) currentDiag.childStrengths = s.value;
          if (im) currentDiag.areasForImprovement = im.value;
          submitDiagnostic();
        } else {
          goToSection(currentSection + 1);
        }
      };
      document.getElementById("diag-close-btn").onclick = function () {
        if (
          confirm(
            "Are you sure? Your progress will be saved but the assessment will remain pending.",
          )
        ) {
          saveDiagnosticProgress();
          document.getElementById("diag-overlay").classList.remove("active");
        }
      };

      function saveDiagnosticProgress() {
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("diagnostics")
          .doc(currentDiagId)
          .set(currentDiag);
      }

      function submitDiagnostic() {
        var totalScore = 0;
        currentDiag.sections.forEach(function (section) {
          var sectionScore = 0;
          section.items.forEach(function (item) {
            if (item.response === "correct") sectionScore += 1;
            else if (item.response === "partial") sectionScore += 0.5;
          });
          section.score = sectionScore;
          totalScore += sectionScore;
        });
        currentDiag.totalScore = totalScore;
        currentDiag.status = "completed";
        currentDiag.completedAt = new Date();
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("diagnostics")
          .doc(currentDiagId)
          .set(currentDiag)
          .then(function () {
            document.getElementById("diag-overlay").classList.remove("active");
            loadDiagnostics();
            var pct = Math.round(
              (totalScore / currentDiag.maxTotalScore) * 100,
            );
            alert(
              "Assessment Complete!\n\nTotal Score: " +
                totalScore +
                " / " +
                currentDiag.maxTotalScore +
                " (" +
                pct +
                "%)\n\nYour teacher will review the results.",
            );
          })
          .catch(function (err) {
            alert("Error saving: " + err.message);
          });
      }

      function viewDiagnosticResults(diagId) {
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("diagnostics")
          .doc(diagId)
          .get()
          .then(function (doc) {
            var diag = doc.data();
            var pct = Math.round((diag.totalScore / diag.maxTotalScore) * 100);
            var grade =
              pct >= 90
                ? "A"
                : pct >= 80
                  ? "B"
                  : pct >= 70
                    ? "C"
                    : pct >= 60
                      ? "D"
                      : "Needs Practice";
            var html = '<div style="max-height:70vh;overflow-y:auto">';
            html +=
              '<div class="results-header"><div class="score-sub">OVERALL SCORE</div><div class="score">' +
              diag.totalScore +
              '<span style="font-size:20px;color:var(--text-muted)">/' +
              diag.maxTotalScore +
              "</span></div>";
            html +=
              '<div class="grade-row"><div><div class="val">' +
              pct +
              '%</div><div class="lbl">Percentage</div></div><div><div class="val">' +
              grade +
              '</div><div class="lbl">Grade</div></div></div></div>';
            html +=
              '<h4 style="margin-bottom:16px;display:flex;align-items:center;gap:8px">' +
              SVG.chart +
              " Section Breakdown</h4>";
            diag.sections.forEach(function (section) {
              var secPct = Math.round((section.score / section.maxScore) * 100);
              var scoreStyle =
                secPct >= 80
                  ? "background:rgba(34,197,94,0.1);color:var(--green);border-color:rgba(34,197,94,0.2)"
                  : secPct >= 60
                    ? "background:rgba(234,179,8,0.1);color:var(--yellow);border-color:rgba(234,179,8,0.2)"
                    : "background:rgba(239,68,68,0.1);color:var(--red);border-color:rgba(239,68,68,0.2)";
              html +=
                '<div class="results-section"><div class="results-section-header" onclick="this.nextElementSibling.classList.toggle(\'open\')"><h4>' +
                section.title +
                '</h4><span class="results-score" style="' +
                scoreStyle +
                '">' +
                section.score +
                "/" +
                section.maxScore +
                " (" +
                secPct +
                '%)</span></div><div class="results-items">';
              section.items.forEach(function (item) {
                var icon =
                  item.response === "correct"
                    ? '<span class="r-icon" style="color:var(--green)">' +
                      SVG.check +
                      "</span>"
                    : item.response === "partial"
                      ? '<span class="r-icon" style="color:var(--yellow)">' +
                        SVG.diamond +
                        "</span>"
                      : item.response === "none"
                        ? '<span class="r-icon" style="color:var(--red)">' +
                          SVG.x +
                          "</span>"
                        : '<span class="r-icon" style="color:var(--text-muted)">' +
                          SVG.circle +
                          "</span>";
                html +=
                  '<div class="results-item">' +
                  icon +
                  '<span style="font-size:20px">' +
                  item.emoji +
                  '</span><span style="flex:1"><strong>' +
                  item.portuguese +
                  '</strong> <span style="color:var(--text-muted)">(' +
                  item.english +
                  ")</span></span></div>";
              });
              html += "</div></div>";
            });
            if (
              diag.parentNotes ||
              diag.childStrengths ||
              diag.areasForImprovement
            ) {
              html +=
                '<h4 style="margin:24px 0 16px;display:flex;align-items:center;gap:8px">' +
                SVG.edit +
                " Notes & Observations</h4>";
              if (diag.parentNotes)
                html +=
                  '<div style="padding:16px;background:var(--bg-tertiary);border-radius:var(--radius-lg);margin-bottom:12px;border:1px solid var(--border)"><div style="font-weight:600;margin-bottom:8px">Parent Notes</div><p style="color:var(--text-secondary);line-height:1.6">' +
                  diag.parentNotes +
                  "</p></div>";
              if (diag.childStrengths)
                html +=
                  '<div style="padding:16px;background:rgba(34,197,94,0.06);border-radius:var(--radius-lg);margin-bottom:12px;border:1px solid rgba(34,197,94,0.15)"><div style="font-weight:600;margin-bottom:8px;color:var(--green);display:flex;align-items:center;gap:8px">' +
                  SVG.muscle +
                  ' Strengths</div><p style="color:var(--text-secondary);line-height:1.6">' +
                  diag.childStrengths +
                  "</p></div>";
              if (diag.areasForImprovement)
                html +=
                  '<div style="padding:16px;background:rgba(234,179,8,0.06);border-radius:var(--radius-lg);margin-bottom:12px;border:1px solid rgba(234,179,8,0.15)"><div style="font-weight:600;margin-bottom:8px;color:var(--yellow);display:flex;align-items:center;gap:8px">' +
                  SVG.trending +
                  ' Areas for Improvement</div><p style="color:var(--text-secondary);line-height:1.6">' +
                  diag.areasForImprovement +
                  "</p></div>";
            }
            if (diag.completedAt) {
              html +=
                '<p style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border);color:var(--text-muted);font-size:13px;display:flex;align-items:center;gap:6px">' +
                SVG.check +
                " Completed: " +
                new Date(diag.completedAt.seconds * 1000).toLocaleDateString(
                  "en-US",
                  {
                    weekday: "long",
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                  },
                );
              if (diag.estimatedTime)
                html += " &middot; Est. time: " + diag.estimatedTime;
              html += "</p>";
            }
            html += "</div>";
            openModal("Assessment Results", html);
          });
      }

      // Add Item Buttons
      ["diagnostic", "game", "test", "link", "progress"].forEach(
        function (type) {
          var btn = document.getElementById("add-" + type + "-btn");
          if (btn) {
            btn.onclick = function () {
              if (!selectedStudent) {
                alert("Select a student first");
                return;
              }
              var fields =
                type === "game" || type === "link"
                  ? ["title", "url", "description"]
                  : ["title", "description", "status"];
              var html = '<form id="item-form">';
              fields.forEach(function (f) {
                if (f === "status")
                  html +=
                    '<div class="form-group"><label>Status</label><select name="status"><option value="pending">Pending</option><option value="completed">Completed</option></select></div>';
                else
                  html +=
                    '<div class="form-group"><label>' +
                    f.charAt(0).toUpperCase() +
                    f.slice(1) +
                    '</label><input type="' +
                    (f === "url" ? "url" : "text") +
                    '" name="' +
                    f +
                    '" ' +
                    (f === "title" ? "required" : "") +
                    "></div>";
              });
              html += '<button type="submit" class="btn">Add</button></form>';
              openModal(
                "Add " + type.charAt(0).toUpperCase() + type.slice(1),
                html,
              );
              document.getElementById("item-form").onsubmit = function (e) {
                e.preventDefault();
                var form = new FormData(this);
                var data = { createdAt: new Date() };
                fields.forEach(function (f) {
                  data[f] = form.get(f) || "";
                });
                var col = type === "progress" ? "progress" : type + "s";
                db.collection("students")
                  .doc(selectedStudent.id)
                  .collection(col)
                  .add(data)
                  .then(function () {
                    closeModal();
                    loadStudentData();
                  })
                  .catch(function (e) {
                    alert("Error: " + e.message);
                  });
              };
            };
          }
        },
      );

      function toggleGameComplete(gameId, isCurrentlyComplete) {
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("games")
          .doc(gameId)
          .update({ completed: !isCurrentlyComplete })
          .then(function () {
            loadStudentData();
          })
          .catch(function (e) {
            alert("Error toggling game: " + e.message);
          });
      }

      function deleteItem(collection, docId) {
        if (!confirm("Are you sure you want to delete this item?")) return;
        db.collection("students")
          .doc(selectedStudent.id)
          .collection(collection)
          .doc(docId)
          .delete()
          .then(function () {
            loadStudentData();
          })
          .catch(function (e) {
            alert("Error deleting: " + e.message);
          });
      }

      function openModal(title, content) {
        document.getElementById("modal-title").textContent = title;
        document.getElementById("modal-content").innerHTML = content;
        document.getElementById("modal-overlay").classList.remove("hidden");
      }
      function closeModal() {
        document.getElementById("modal-overlay").classList.add("hidden");
      }
      document.getElementById("modal-overlay").onclick = function (e) {
        if (e.target === this) closeModal();
      };
      document.getElementById("modal-close-btn").onclick = closeModal;

      // ========== CLASS LOG ==========
      function loadClassLog() {
        if (!selectedStudent) return;
        var list = document.getElementById("classlog-list");
        var isAdmin = currentUser && currentUser.role === "admin";
        var addBtn = document.getElementById("add-classlog-btn");
        if (addBtn) addBtn.style.display = isAdmin ? "" : "none";

        db.collection("students")
          .doc(selectedStudent.id)
          .collection("classLogs")
          .orderBy("date", "desc")
          .get()
          .then(function (snap) {
            if (snap.empty) {
              list.innerHTML =
                '<div class="empty-state">No class log entries yet</div>';
              return;
            }
            list.innerHTML = "";
            snap.forEach(function (doc) {
              var entry = doc.data(),
                entryId = doc.id,
                dateStr = entry.date || "No date";
              var div = document.createElement("div");
              div.className = "log-entry";
              var deleteBtn = isAdmin
                ? '<button class="delete-btn" onclick="deleteClassLog(\'' +
                  entryId +
                  "')\">" +
                  SVG.trash +
                  "</button>"
                : "";
              var html =
                '<div class="log-entry-header"><div class="log-entry-date">' +
                SVG.calendar +
                " " +
                dateStr;
              if (entry.duration)
                html +=
                  "<small>" + SVG.clock + " " + entry.duration + "</small>";
              html += "</div>" + deleteBtn + "</div>";
              if (entry.topics) {
                html +=
                  '<div class="log-detail"><div class="log-detail-label">Topics Covered</div><div class="log-tags">';
                entry.topics.split(",").forEach(function (t) {
                  html += '<span class="log-tag">' + t.trim() + "</span>";
                });
                html += "</div></div>";
              }
              if (entry.activities)
                html +=
                  '<div class="log-detail"><div class="log-detail-label">Activities</div><div class="log-detail-value">' +
                  entry.activities +
                  "</div></div>";
              if (entry.homework)
                html +=
                  '<div class="log-detail"><div class="log-detail-label">Homework</div><div class="log-detail-value" style="display:flex;align-items:center;gap:6px">' +
                  SVG.homework +
                  " " +
                  entry.homework +
                  "</div></div>";
              if (entry.notes)
                html +=
                  '<div class="log-detail"><div class="log-detail-label">Teacher Notes</div><div class="log-detail-value">' +
                  entry.notes +
                  "</div></div>";
              html +=
                '<div class="log-comments"><h4>' +
                SVG.chat +
                ' Comments</h4><div id="comments-' +
                entryId +
                '">';
              if (entry.comments && entry.comments.length > 0) {
                entry.comments.forEach(function (c) {
                  html +=
                    '<div class="log-comment"><span class="log-comment-author">' +
                    c.author +
                    '</span><span class="log-comment-date">' +
                    c.date +
                    '</span><div class="log-comment-text">' +
                    c.text +
                    "</div></div>";
                });
              } else {
                html +=
                  '<div style="color:var(--text-muted);font-size:13px">No comments yet</div>';
              }
              html +=
                '</div><div class="log-add-comment"><input type="text" id="comment-input-' +
                entryId +
                '" placeholder="Add a comment..."><button onclick="addClassLogComment(\'' +
                entryId +
                "')\">Send</button></div></div>";
              div.innerHTML = html;
              list.appendChild(div);
            });
          })
          .catch(function (e) {
            list.innerHTML =
              '<div class="empty-state">Error loading class log: ' +
              e.message +
              "</div>";
          });
      }

      document.getElementById("add-classlog-btn").onclick = function () {
        if (!selectedStudent) {
          alert("Select a student first");
          return;
        }
        var today = new Date().toISOString().split("T")[0];
        openModal(
          "Add Class Log Entry",
          '<form id="classlog-form"><div class="form-group"><label>Date</label><input type="date" name="date" value="' +
            today +
            '" required></div><div class="form-group"><label>Duration</label><input type="text" name="duration" placeholder="e.g. 45 minutes"></div><div class="form-group"><label>Topics Covered (comma-separated)</label><input type="text" name="topics" placeholder="e.g. Greetings, Colors, Numbers" required></div><div class="form-group"><label>Activities</label><textarea name="activities" rows="3" placeholder="What did you do in class?"></textarea></div><div class="form-group"><label>Homework</label><input type="text" name="homework" placeholder="Any homework assigned?"></div><div class="form-group"><label>Teacher Notes</label><textarea name="notes" rows="3" placeholder="Observations, progress, areas to revisit..."></textarea></div><button type="submit" class="btn">Save Entry</button></form>',
        );
        document.getElementById("classlog-form").onsubmit = function (e) {
          e.preventDefault();
          var form = new FormData(this);
          db.collection("students")
            .doc(selectedStudent.id)
            .collection("classLogs")
            .add({
              date: form.get("date"),
              duration: form.get("duration"),
              topics: form.get("topics"),
              activities: form.get("activities"),
              homework: form.get("homework"),
              notes: form.get("notes"),
              comments: [],
              createdAt: new Date(),
            })
            .then(function () {
              closeModal();
              loadClassLog();
            })
            .catch(function (e) {
              alert("Error: " + e.message);
            });
        };
      };

      function addClassLogComment(entryId) {
        var input = document.getElementById("comment-input-" + entryId);
        var text = input.value.trim();
        if (!text) return;
        var comment = {
          author: currentUser.name,
          text: text,
          date: new Date().toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
            year: "numeric",
          }),
        };
        var docRef = db
          .collection("students")
          .doc(selectedStudent.id)
          .collection("classLogs")
          .doc(entryId);
        docRef
          .get()
          .then(function (doc) {
            var comments = doc.data().comments || [];
            comments.push(comment);
            return docRef.update({ comments: comments });
          })
          .then(function () {
            loadClassLog();
          })
          .catch(function (e) {
            alert("Error adding comment: " + e.message);
          });
      }

      function deleteClassLog(entryId) {
        if (!confirm("Delete this class log entry?")) return;
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("classLogs")
          .doc(entryId)
          .delete()
          .then(function () {
            loadClassLog();
          })
          .catch(function (e) {
            alert("Error: " + e.message);
          });
      }

      // ========== VOCABULARY BANK ==========
      function loadVocab() {
        if (!selectedStudent) return;
        var list = document.getElementById("vocab-list");
        var isAdmin = currentUser && currentUser.role === "admin";
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("vocab")
          .orderBy("createdAt", "desc")
          .get()
          .then(function (snap) {
            while (list.children.length > 1) list.removeChild(list.lastChild);
            if (snap.empty) return;
            snap.forEach(function (doc) {
              var word = doc.data();
              var mastery = word.mastery || 0;
              var masteryColor =
                mastery >= 80
                  ? "var(--green)"
                  : mastery >= 50
                    ? "var(--yellow)"
                    : "var(--red)";
              var deleteBtn = isAdmin
                ? '<button class="delete-btn" onclick="deleteVocabWord(\'' +
                  doc.id +
                  "')\">" +
                  SVG.trash +
                  "</button>"
                : "";
              var card = document.createElement("div");
              card.className = "vocab-card";
              card.setAttribute(
                "data-word",
                (
                  word.portuguese +
                  " " +
                  word.english +
                  " " +
                  (word.category || "")
                ).toLowerCase(),
              );
              card.innerHTML =
                '<div class="vocab-emoji">' +
                (word.emoji || "📝") +
                "</div>" +
                '<div class="vocab-content">' +
                '<div class="vocab-pt">' +
                word.portuguese +
                "</div>" +
                '<div class="vocab-en">' +
                word.english +
                "</div>" +
                '<div class="vocab-meta">' +
                (word.category
                  ? '<span class="vocab-category">' + word.category + "</span>"
                  : "") +
                '<span class="vocab-mastery"><span class="vocab-mastery-bar"><span class="vocab-mastery-fill" style="width:' +
                mastery +
                "%;background:" +
                masteryColor +
                '"></span></span> ' +
                mastery +
                "%</span>" +
                "</div>" +
                "</div>" +
                '<div style="display:flex;align-items:center;gap:6px">' +
                '<button class="btn-small" onclick="updateMastery(\'' +
                doc.id +
                "'," +
                mastery +
                ')" title="Update mastery">' +
                SVG.star +
                "</button>" +
                deleteBtn +
                "</div>";
              list.appendChild(card);
            });
          });
      }

      function filterVocab(query) {
        var q = query.toLowerCase();
        document
          .querySelectorAll("#vocab-list .vocab-card")
          .forEach(function (card) {
            var words = card.getAttribute("data-word") || "";
            card.style.display = words.indexOf(q) !== -1 ? "" : "none";
          });
      }

      function updateMastery(vocabId, current) {
        var newVal = prompt("Set mastery % (0-100):", current);
        if (newVal === null) return;
        newVal = Math.max(0, Math.min(100, parseInt(newVal) || 0));
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("vocab")
          .doc(vocabId)
          .update({ mastery: newVal })
          .then(function () {
            loadVocab();
          });
      }

      function deleteVocabWord(vocabId) {
        if (!confirm("Delete this word?")) return;
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("vocab")
          .doc(vocabId)
          .delete()
          .then(function () {
            loadVocab();
          });
      }

      document.getElementById("add-vocab-btn").onclick = function () {
        if (!selectedStudent) {
          alert("Select a student first");
          return;
        }
        openModal(
          "Add Vocabulary Word",
          '<form id="vocab-form">' +
            '<div class="form-group"><label>Emoji</label><input type="text" name="emoji" placeholder="🏠" maxlength="4"></div>' +
            '<div class="form-group"><label>Portuguese</label><input type="text" name="portuguese" required placeholder="casa"></div>' +
            '<div class="form-group"><label>English</label><input type="text" name="english" required placeholder="house"></div>' +
            '<div class="form-group"><label>Category</label><input type="text" name="category" placeholder="e.g. Animals, Food, Colors"></div>' +
            '<div class="form-group"><label>Mastery %</label><input type="number" name="mastery" min="0" max="100" value="0"></div>' +
            '<button type="submit" class="btn">Add Word</button></form>',
        );
        document.getElementById("vocab-form").onsubmit = function (e) {
          e.preventDefault();
          var form = new FormData(this);
          db.collection("students")
            .doc(selectedStudent.id)
            .collection("vocab")
            .add({
              emoji: form.get("emoji") || "📝",
              portuguese: form.get("portuguese"),
              english: form.get("english"),
              category: form.get("category"),
              mastery: parseInt(form.get("mastery")) || 0,
              createdAt: new Date(),
            })
            .then(function () {
              closeModal();
              loadVocab();
            });
        };
      };

      // ========== CLASS BOOK ==========
      function loadClassBook() {
        if (!selectedStudent) return;
        var list = document.getElementById("classbook-list");
        var isAdmin = currentUser && currentUser.role === "admin";
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("classbook")
          .orderBy("createdAt", "desc")
          .get()
          .then(function (snap) {
            list.innerHTML = "";
            if (isAdmin) {
              list.innerHTML =
                '<div class="add-item-card"><button id="add-classbook-btn" class="btn-small">+ Add Resource</button></div>';
              document.getElementById("add-classbook-btn").onclick =
                addClassBookResource;
            }
            if (snap.empty) {
              list.innerHTML +=
                '<div class="empty-state">No class book resources yet</div>';
              return;
            }
            snap.forEach(function (doc) {
              var r = doc.data();
              var typeEmoji =
                r.type === "textbook"
                  ? "📖"
                  : r.type === "video"
                    ? "🎬"
                    : r.type === "worksheet"
                      ? "📝"
                      : r.type === "app"
                        ? "📱"
                        : r.type === "website"
                          ? "🌐"
                          : "📚";
              var card = document.createElement("div");
              card.className = "item-card";
              card.setAttribute("data-resource", (r.title || "").toLowerCase());
              var actions = isAdmin
                ? '<div class="item-actions"><button class="btn-icon" title="Delete" onclick="deleteClassBookResource(\'' +
                  doc.id +
                  "')\">🗑</button></div>"
                : "";
              card.innerHTML =
                '<div class="item-header"><div class="item-title">' +
                typeEmoji +
                " " +
                (r.title || "Untitled") +
                "</div>" +
                actions +
                "</div>" +
                '<div class="item-meta">' +
                '<span class="badge">' +
                (r.type || "resource") +
                "</span>" +
                (r.description
                  ? ' <span style="color:var(--text-muted);font-size:12px">' +
                    r.description +
                    "</span>"
                  : "") +
                "</div>" +
                (r.url
                  ? '<a href="' +
                    r.url +
                    '" target="_blank" style="color:#4F46E5;font-size:13px;word-break:break-all">' +
                    r.url +
                    "</a>"
                  : "") +
                (r.notes
                  ? '<div style="margin-top:8px;padding:8px;background:var(--bg-tertiary);border-radius:6px;font-size:12px;color:var(--text-muted)">' +
                    r.notes +
                    "</div>"
                  : "");
              list.appendChild(card);
            });
          });
      }

      function filterClassBook(query) {
        var q = query.toLowerCase();
        document
          .querySelectorAll("#classbook-list .item-card")
          .forEach(function (card) {
            var match =
              (card.getAttribute("data-resource") || "").indexOf(q) !== -1;
            card.style.display = match ? "" : "none";
          });
      }

      function deleteClassBookResource(resId) {
        if (!confirm("Delete this resource?")) return;
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("classbook")
          .doc(resId)
          .delete()
          .then(function () {
            loadClassBook();
          });
      }

      function addClassBookResource() {
        openModal(
          "Add Class Book Resource",
          '<form id="classbook-form">' +
            '<div class="form-group"><label>Title</label><input type="text" id="cb-title" required placeholder="e.g. Zig Zag A0 Workbook"></div>' +
            '<div class="form-group"><label>Type</label><select id="cb-type"><option value="textbook">📖 Textbook</option><option value="worksheet">📝 Worksheet</option><option value="video">🎬 Video</option><option value="website">🌐 Website</option><option value="app">📱 App</option><option value="other">📚 Other</option></select></div>' +
            '<div class="form-group"><label>URL (optional)</label><input type="url" id="cb-url" placeholder="https://..."></div>' +
            '<div class="form-group"><label>Description (optional)</label><input type="text" id="cb-desc" placeholder="Short description"></div>' +
            '<div class="form-group"><label>Notes (optional)</label><textarea id="cb-notes" rows="3" placeholder="Pages to cover, chapters, teacher notes..."></textarea></div>' +
            '<button type="submit" class="btn">Add Resource</button></form>',
        );
        document.getElementById("classbook-form").onsubmit = function (e) {
          e.preventDefault();
          var title = document.getElementById("cb-title").value.trim();
          var type = document.getElementById("cb-type").value;
          var url = document.getElementById("cb-url").value.trim();
          var desc = document.getElementById("cb-desc").value.trim();
          var notes = document.getElementById("cb-notes").value.trim();
          if (!title) return;
          db.collection("students")
            .doc(selectedStudent.id)
            .collection("classbook")
            .add({
              title: title,
              type: type,
              url: url || null,
              description: desc || null,
              notes: notes || null,
              createdAt: new Date(),
            })
            .then(function () {
              closeModal();
              loadClassBook();
            });
        };
      }

      // ========== HOMEWORK TRACKER ==========
      function loadHomework() {
        if (!selectedStudent) return;
        var list = document.getElementById("homework-list");
        var isAdmin = currentUser && currentUser.role === "admin";
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("homework")
          .orderBy("dueDate", "asc")
          .get()
          .then(function (snap) {
            while (list.children.length > 1) list.removeChild(list.lastChild);
            if (snap.empty) return;
            snap.forEach(function (doc) {
              var hw = doc.data();
              var progress = hw.progress || 0;
              var dueDate = hw.dueDate || "";
              var dueClass = "upcoming";
              var dueLabel = dueDate;
              if (dueDate) {
                var today = new Date();
                today.setHours(0, 0, 0, 0);
                var due = new Date(dueDate + "T00:00:00");
                var diff = Math.ceil((due - today) / 86400000);
                if (diff < 0) {
                  dueClass = "overdue";
                  dueLabel = "Overdue";
                } else if (diff === 0) {
                  dueClass = "today";
                  dueLabel = "Due Today";
                } else {
                  dueLabel =
                    "Due " +
                    due.toLocaleDateString("en-US", {
                      month: "short",
                      day: "numeric",
                    });
                }
              }
              var deleteBtn = isAdmin
                ? '<button class="delete-btn" onclick="deleteHomework(\'' +
                  doc.id +
                  "')\">" +
                  SVG.trash +
                  " Delete</button>"
                : "";
              var toggleBtn =
                '<button class="btn-small" onclick="toggleHomeworkDone(\'' +
                doc.id +
                "'," +
                progress +
                ')">' +
                (progress >= 100 ? SVG.check + " Done" : "✓ Mark Done") +
                "</button>";
              var card = document.createElement("div");
              card.className = "homework-card";
              card.innerHTML =
                '<div class="homework-header"><div class="homework-title">' +
                (hw.title || "Assignment") +
                "</div>" +
                '<span class="homework-due ' +
                dueClass +
                '">' +
                dueLabel +
                "</span></div>" +
                (hw.description
                  ? '<div class="homework-desc">' + hw.description + "</div>"
                  : "") +
                '<div class="homework-progress"><div class="homework-progress-bar"><div class="homework-progress-fill" style="width:' +
                progress +
                '%"></div></div><span class="homework-progress-text">' +
                progress +
                "%</span></div>" +
                '<div class="item-actions">' +
                toggleBtn +
                deleteBtn +
                "</div>";
              list.appendChild(card);
            });
          });
      }

      function toggleHomeworkDone(hwId, current) {
        var newProgress = current >= 100 ? 0 : 100;
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("homework")
          .doc(hwId)
          .update({ progress: newProgress })
          .then(function () {
            loadHomework();
          });
      }

      function deleteHomework(hwId) {
        if (!confirm("Delete this assignment?")) return;
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("homework")
          .doc(hwId)
          .delete()
          .then(function () {
            loadHomework();
          });
      }

      document.getElementById("add-homework-btn").onclick = function () {
        if (!selectedStudent) {
          alert("Select a student first");
          return;
        }
        var today = new Date().toISOString().split("T")[0];
        openModal(
          "Add Assignment",
          '<form id="homework-form">' +
            '<div class="form-group"><label>Title</label><input type="text" name="title" required placeholder="e.g. Practice greetings"></div>' +
            '<div class="form-group"><label>Description</label><textarea name="description" rows="3" placeholder="What should they do?"></textarea></div>' +
            '<div class="form-group"><label>Due Date</label><input type="date" name="dueDate" value="' +
            today +
            '"></div>' +
            '<button type="submit" class="btn">Add Assignment</button></form>',
        );
        document.getElementById("homework-form").onsubmit = function (e) {
          e.preventDefault();
          var form = new FormData(this);
          db.collection("students")
            .doc(selectedStudent.id)
            .collection("homework")
            .add({
              title: form.get("title"),
              description: form.get("description"),
              dueDate: form.get("dueDate"),
              progress: 0,
              createdAt: new Date(),
            })
            .then(function () {
              closeModal();
              loadHomework();
            });
        };
      };

      // ========== CLASS TIMER ==========
      var timerSeconds = 0;
      var timerInterval = null;
      var timerRunning = false;
      var timerTarget = 0;

      // Show timer for admin users after login
      var _origLoginSuccess = loginSuccess;
      loginSuccess = function (username, userData) {
        _origLoginSuccess(username, userData);
        if (userData.role === "admin") {
          document.getElementById("timer-widget").classList.add("visible");
          document.getElementById("student-nav").classList.add("admin-mode");
        }
      };

      function toggleTimerPanel() {
        document.getElementById("timer-panel").classList.toggle("open");
      }

      function setTimer(minutes) {
        timerTarget = minutes * 60;
        timerSeconds = timerTarget;
        updateTimerDisplay();
      }

      function updateTimerDisplay() {
        var mins = Math.floor(Math.abs(timerSeconds) / 60);
        var secs = Math.abs(timerSeconds) % 60;
        var display =
          (mins < 10 ? "0" : "") + mins + ":" + (secs < 10 ? "0" : "") + secs;
        document.getElementById("timer-display").textContent = display;
        var fabTime = document.getElementById("timer-fab-time");
        var fabIcon = document.getElementById("timer-fab-icon");
        if (timerRunning) {
          fabTime.textContent = display;
          fabTime.style.display = "block";
          fabIcon.style.display = "none";
        } else {
          fabTime.style.display = "none";
          fabIcon.style.display = "block";
        }
      }

      document.getElementById("timer-start").onclick = function () {
        if (timerRunning) {
          clearInterval(timerInterval);
          timerRunning = false;
          this.textContent = "Start";
        } else {
          if (timerSeconds === 0 && timerTarget === 0) {
            timerTarget = -1; // Count up mode
          }
          timerRunning = true;
          this.textContent = "Pause";
          timerInterval = setInterval(function () {
            if (timerTarget > 0) {
              timerSeconds--;
              if (timerSeconds <= 0) {
                clearInterval(timerInterval);
                timerRunning = false;
                document.getElementById("timer-start").textContent = "Start";
                timerSeconds = 0;
                try {
                  var ctx = new AudioContext();
                  ctx.resume();
                  var o = ctx.createOscillator();
                  o.type = "sine";
                  o.frequency.value = 880;
                  var g = ctx.createGain();
                  g.gain.setValueAtTime(0.3, ctx.currentTime);
                  g.gain.exponentialRampToValueAtTime(
                    0.01,
                    ctx.currentTime + 1,
                  );
                  o.connect(g);
                  g.connect(ctx.destination);
                  o.start();
                  o.stop(ctx.currentTime + 1);
                } catch (e) {}
              }
            } else {
              timerSeconds++;
            }
            updateTimerDisplay();
          }, 1000);
        }
        updateTimerDisplay();
      };

      document.getElementById("timer-reset").onclick = function () {
        clearInterval(timerInterval);
        timerRunning = false;
        timerSeconds = timerTarget > 0 ? timerTarget : 0;
        document.getElementById("timer-start").textContent = "Start";
        updateTimerDisplay();
      };

      // ========== LESSON PLANNER ==========
      var plannerDate = new Date();

      function getWeekDates(date) {
        var d = new Date(date);
        var day = d.getDay();
        var diff = d.getDate() - day + (day === 0 ? -6 : 1);
        var monday = new Date(d.setDate(diff));
        var dates = [];
        for (var i = 0; i < 7; i++) {
          var dd = new Date(monday);
          dd.setDate(monday.getDate() + i);
          dates.push(dd);
        }
        return dates;
      }

      function renderPlanner() {
        var dates = getWeekDates(plannerDate);
        var cal = document.getElementById("planner-calendar");
        var today = new Date();
        today.setHours(0, 0, 0, 0);
        var monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];
        document.getElementById("planner-month").textContent =
          monthNames[dates[0].getMonth()] + " " + dates[0].getFullYear();
        var dayNames = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
        cal.innerHTML = "";
        dates.forEach(function (d, i) {
          var div = document.createElement("div");
          div.className =
            "planner-day" + (d.getTime() === today.getTime() ? " today" : "");
          div.innerHTML =
            '<div class="planner-day-label">' +
            dayNames[i] +
            '</div><div class="planner-day-num">' +
            d.getDate() +
            "</div>";
          div.onclick = function () {
            plannerDate = d;
            loadPlannerLessons();
          };
          cal.appendChild(div);
        });
        loadPlannerLessons();
      }

      function loadPlannerLessons() {
        if (!selectedStudent) return;
        var dates = getWeekDates(plannerDate);
        var startStr = dates[0].toISOString().split("T")[0];
        var endStr = dates[6].toISOString().split("T")[0];
        var lessonsDiv = document.getElementById("planner-lessons");
        var emptyDiv = document.getElementById("planner-empty");
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("lessons")
          .orderBy("date", "asc")
          .get()
          .then(function (snap) {
            lessonsDiv.innerHTML = "";
            var count = 0;
            snap.forEach(function (doc) {
              var lesson = doc.data();
              if (lesson.date >= startStr && lesson.date <= endStr) {
                count++;
                var isAdmin = currentUser && currentUser.role === "admin";
                var deleteBtn = isAdmin
                  ? '<button class="delete-btn" onclick="deleteLesson(\'' +
                    doc.id +
                    "')\">" +
                    SVG.trash +
                    "</button>"
                  : "";
                var div = document.createElement("div");
                div.className = "planner-lesson";
                div.innerHTML =
                  '<div style="display:flex;justify-content:space-between;align-items:flex-start">' +
                  '<div><div class="planner-lesson-time">' +
                  SVG.calendar +
                  " " +
                  lesson.date +
                  (lesson.time ? " · " + lesson.time : "") +
                  "</div>" +
                  '<div class="planner-lesson-title">' +
                  (lesson.title || "Lesson") +
                  "</div></div>" +
                  deleteBtn +
                  "</div>" +
                  (lesson.topics
                    ? '<div class="planner-lesson-topics">' +
                      lesson.topics
                        .split(",")
                        .map(function (t) {
                          return (
                            '<span class="log-tag">' + t.trim() + "</span>"
                          );
                        })
                        .join("") +
                      "</div>"
                    : "") +
                  (lesson.notes
                    ? '<div style="margin-top:8px;font-size:13px;color:var(--text-muted)">' +
                      lesson.notes +
                      "</div>"
                    : "");
                lessonsDiv.appendChild(div);
              }
            });
            // Mark days with lessons
            var allDates = [];
            snap.forEach(function (doc) {
              allDates.push(doc.data().date);
            });
            document
              .querySelectorAll(".planner-day")
              .forEach(function (dayEl, idx) {
                var dateStr = dates[idx].toISOString().split("T")[0];
                if (allDates.indexOf(dateStr) !== -1) {
                  dayEl.classList.add("has-lesson");
                  if (!dayEl.querySelector(".planner-day-dot")) {
                    var dot = document.createElement("div");
                    dot.className = "planner-day-dot";
                    dayEl.appendChild(dot);
                  }
                }
              });
            if (emptyDiv)
              emptyDiv.style.display = count === 0 ? "block" : "none";
          });
      }

      function deleteLesson(lessonId) {
        if (!confirm("Delete this lesson?")) return;
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("lessons")
          .doc(lessonId)
          .delete()
          .then(function () {
            loadPlannerLessons();
          });
      }

      document.getElementById("planner-prev").onclick = function () {
        plannerDate.setDate(plannerDate.getDate() - 7);
        renderPlanner();
      };
      document.getElementById("planner-next").onclick = function () {
        plannerDate.setDate(plannerDate.getDate() + 7);
        renderPlanner();
      };

      document.getElementById("add-lesson-btn").onclick = function () {
        if (!selectedStudent) {
          alert("Select a student first");
          return;
        }
        var today = new Date().toISOString().split("T")[0];
        openModal(
          "Add Lesson",
          '<form id="lesson-form">' +
            '<div class="form-group"><label>Date</label><input type="date" name="date" value="' +
            today +
            '" required></div>' +
            '<div class="form-group"><label>Time</label><input type="time" name="time"></div>' +
            '<div class="form-group"><label>Title</label><input type="text" name="title" required placeholder="e.g. Colors & Shapes"></div>' +
            '<div class="form-group"><label>Topics (comma-separated)</label><input type="text" name="topics" placeholder="Colors, Numbers, Shapes"></div>' +
            '<div class="form-group"><label>Notes</label><textarea name="notes" rows="3" placeholder="Lesson plan notes..."></textarea></div>' +
            '<button type="submit" class="btn">Add Lesson</button></form>',
        );
        document.getElementById("lesson-form").onsubmit = function (e) {
          e.preventDefault();
          var form = new FormData(this);
          db.collection("students")
            .doc(selectedStudent.id)
            .collection("lessons")
            .add({
              date: form.get("date"),
              time: form.get("time"),
              title: form.get("title"),
              topics: form.get("topics"),
              notes: form.get("notes"),
              createdAt: new Date(),
            })
            .then(function () {
              closeModal();
              loadPlannerLessons();
            });
        };
      };

      // ========== PROGRESS CHARTS ==========
      function loadProgressCharts() {
        if (!selectedStudent) return;
        var panel = document.getElementById("progress-panel");
        // Remove old charts if any
        var oldCharts = panel.querySelector(".progress-overview");
        if (oldCharts) oldCharts.remove();
        var oldChart = panel.querySelector(".progress-chart");
        if (oldChart) oldChart.remove();

        // Gather stats from all collections
        var stats = {
          vocab: 0,
          homework: 0,
          hwDone: 0,
          lessons: 0,
          games: 0,
          classLogs: 0,
        };
        var vocabCategories = {};
        var promises = [];

        promises.push(
          db
            .collection("students")
            .doc(selectedStudent.id)
            .collection("vocab")
            .get()
            .then(function (s) {
              stats.vocab = s.size;
              s.forEach(function (d) {
                var cat = d.data().category || "Other";
                vocabCategories[cat] = (vocabCategories[cat] || 0) + 1;
              });
            }),
        );
        promises.push(
          db
            .collection("students")
            .doc(selectedStudent.id)
            .collection("homework")
            .get()
            .then(function (s) {
              stats.homework = s.size;
              s.forEach(function (d) {
                if (d.data().progress >= 100) stats.hwDone++;
              });
            }),
        );
        promises.push(
          db
            .collection("students")
            .doc(selectedStudent.id)
            .collection("lessons")
            .get()
            .then(function (s) {
              stats.lessons = s.size;
            }),
        );
        promises.push(
          db
            .collection("students")
            .doc(selectedStudent.id)
            .collection("games")
            .get()
            .then(function (s) {
              stats.games = s.size;
            }),
        );
        promises.push(
          db
            .collection("students")
            .doc(selectedStudent.id)
            .collection("classLogs")
            .get()
            .then(function (s) {
              stats.classLogs = s.size;
            }),
        );

        Promise.all(promises).then(function () {
          var list = document.getElementById("progress-list");
          // Insert overview before items
          var overview = document.createElement("div");
          overview.className = "progress-overview";
          overview.innerHTML =
            '<div class="progress-stat"><div class="progress-stat-value">' +
            stats.vocab +
            '</div><div class="progress-stat-label">Words Learned</div></div>' +
            '<div class="progress-stat"><div class="progress-stat-value">' +
            stats.hwDone +
            "/" +
            stats.homework +
            '</div><div class="progress-stat-label">HW Complete</div></div>' +
            '<div class="progress-stat"><div class="progress-stat-value">' +
            stats.lessons +
            '</div><div class="progress-stat-label">Lessons</div></div>' +
            '<div class="progress-stat"><div class="progress-stat-value">' +
            stats.classLogs +
            '</div><div class="progress-stat-label">Classes</div></div>' +
            '<div class="progress-stat"><div class="progress-stat-value">' +
            stats.games +
            '</div><div class="progress-stat-label">Games</div></div>';
          panel.insertBefore(overview, list);

          // Vocab category bar chart
          var cats = Object.keys(vocabCategories);
          if (cats.length > 0) {
            var maxCat = Math.max.apply(
              null,
              cats.map(function (c) {
                return vocabCategories[c];
              }),
            );
            var chart = document.createElement("div");
            chart.className = "progress-chart";
            chart.innerHTML =
              "<h4>" +
              SVG.chart +
              ' Vocabulary by Category</h4><div class="bar-chart">' +
              cats
                .map(function (c) {
                  var pct = Math.round((vocabCategories[c] / maxCat) * 100);
                  return (
                    '<div class="bar-chart-col"><div class="bar-chart-bar" style="height:' +
                    pct +
                    '%"></div><div class="bar-chart-label">' +
                    c +
                    "</div></div>"
                  );
                })
                .join("") +
              "</div>";
            panel.insertBefore(chart, list);
          }
        });
      }

      // ========== EXPORT DIAGNOSTICS TO PDF ==========
      function exportDiagnosticPDF(diagId) {
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("diagnostics")
          .doc(diagId)
          .get()
          .then(function (doc) {
            var diag = doc.data();
            if (!diag.sections) {
              alert("No data to export");
              return;
            }
            var pct = Math.round((diag.totalScore / diag.maxTotalScore) * 100);
            var text = "DIAGNOSTIC ASSESSMENT REPORT\n";
            text += "============================\n\n";
            text += "Student: " + (selectedStudent.name || "") + "\n";
            text += "Assessment: " + (diag.title || "") + "\n";
            text +=
              "Score: " +
              diag.totalScore +
              " / " +
              diag.maxTotalScore +
              " (" +
              pct +
              "%)\n";
            if (diag.completedAt)
              text +=
                "Completed: " +
                new Date(diag.completedAt.seconds * 1000).toLocaleDateString() +
                "\n";
            text += "\n";
            diag.sections.forEach(function (section) {
              var secPct = Math.round((section.score / section.maxScore) * 100);
              text +=
                "--- " +
                section.title +
                " (" +
                section.score +
                "/" +
                section.maxScore +
                " = " +
                secPct +
                "%) ---\n";
              section.items.forEach(function (item) {
                var mark =
                  item.response === "correct"
                    ? "✓"
                    : item.response === "partial"
                      ? "~"
                      : "✗";
                text +=
                  "  " +
                  mark +
                  " " +
                  item.emoji +
                  " " +
                  item.portuguese +
                  " (" +
                  item.english +
                  ")\n";
              });
              text += "\n";
            });
            if (diag.parentNotes)
              text += "PARENT NOTES:\n" + diag.parentNotes + "\n\n";
            if (diag.childStrengths)
              text += "STRENGTHS:\n" + diag.childStrengths + "\n\n";
            if (diag.areasForImprovement)
              text +=
                "AREAS FOR IMPROVEMENT:\n" + diag.areasForImprovement + "\n\n";

            var blob = new Blob([text], { type: "text/plain" });
            var url = URL.createObjectURL(blob);
            var a = document.createElement("a");
            a.href = url;
            a.download =
              (selectedStudent.name || "student") +
              "-diagnostic-" +
              diagId +
              ".txt";
            a.click();
            URL.revokeObjectURL(url);
          });
      }

      // ========== DRAG TO REORDER ==========
      function enableDragReorder(listId, collection) {
        var list = document.getElementById(listId);
        if (!list) return;
        var dragItem = null;

        list.addEventListener("dragstart", function (e) {
          if (
            e.target.classList.contains("item-card") ||
            e.target.classList.contains("vocab-card") ||
            e.target.classList.contains("homework-card")
          ) {
            dragItem = e.target;
            e.target.classList.add("dragging");
            e.dataTransfer.effectAllowed = "move";
          }
        });
        list.addEventListener("dragend", function (e) {
          if (dragItem) {
            dragItem.classList.remove("dragging");
            document.querySelectorAll(".drag-over").forEach(function (el) {
              el.classList.remove("drag-over");
            });
            dragItem = null;
          }
        });
        list.addEventListener("dragover", function (e) {
          e.preventDefault();
          var target = e.target.closest(
            ".item-card, .vocab-card, .homework-card",
          );
          if (target && target !== dragItem) {
            document.querySelectorAll(".drag-over").forEach(function (el) {
              el.classList.remove("drag-over");
            });
            target.classList.add("drag-over");
          }
        });
        list.addEventListener("drop", function (e) {
          e.preventDefault();
          var target = e.target.closest(
            ".item-card, .vocab-card, .homework-card",
          );
          if (target && dragItem && target !== dragItem) {
            list.insertBefore(dragItem, target);
          }
          document.querySelectorAll(".drag-over").forEach(function (el) {
            el.classList.remove("drag-over");
          });
        });
      }

      // ========== STUDENT PHOTO AVATARS ==========
      function setupAvatarUpload() {
        document.querySelectorAll(".student-item").forEach(function (item) {
          var avatar = item.querySelector(".student-avatar");
          if (!avatar) return;
          avatar.ondblclick = function () {
            if (currentUser.role !== "admin") return;
            var input = document.createElement("input");
            input.type = "file";
            input.accept = "image/*";
            input.onchange = function (e) {
              var file = e.target.files[0];
              if (!file) return;
              var reader = new FileReader();
              reader.onload = function (ev) {
                var dataUrl = ev.target.result;
                avatar.style.backgroundImage = "url(" + dataUrl + ")";
                avatar.classList.add("has-photo");
                avatar.textContent = "";
                // Store in localStorage (lightweight approach)
                var studentName = item.querySelector(".name").textContent;
                localStorage.setItem("bl_avatar_" + studentName, dataUrl);
              };
              reader.readAsDataURL(file);
            };
            input.click();
          };
        });
      }

      function loadAvatarPhotos() {
        document.querySelectorAll(".student-item").forEach(function (item) {
          var avatar = item.querySelector(".student-avatar");
          var name = item.querySelector(".name");
          if (!avatar || !name) return;
          var stored = localStorage.getItem("bl_avatar_" + name.textContent);
          if (stored) {
            avatar.style.backgroundImage = "url(" + stored + ")";
            avatar.classList.add("has-photo");
            avatar.textContent = "";
          }
        });
      }

      // ========== PROFILE EDIT ==========
      var profilePhotoData = null;

      function openProfile() {
        var overlay = document.getElementById("profile-overlay");
        var avatar = document.getElementById("profile-avatar");
        var nameInput = document.getElementById("profile-display-name");
        var roleLabel = document.getElementById("profile-role-label");
        var emailInput = document.getElementById("profile-email");
        var bioInput = document.getElementById("profile-bio");
        var levelField = document.getElementById("profile-level-field");
        var levelSelect = document.getElementById("profile-level");

        // Reset
        profilePhotoData = null;

        // Set display name
        nameInput.value = currentUser.displayName || currentUser.name || "";

        // Set role label
        roleLabel.textContent =
          currentUser.role === "admin" ? "👨‍🏫 Teacher" : "🎓 Student";

        // Load avatar
        var storedAvatar = localStorage.getItem(
          "bl_avatar_" + currentUser.name,
        );
        if (storedAvatar) {
          avatar.style.backgroundImage = "url(" + storedAvatar + ")";
          avatar.textContent = "";
          avatar.style.color = "transparent";
        } else {
          avatar.style.backgroundImage = "";
          avatar.textContent = (currentUser.name || "?")
            .charAt(0)
            .toUpperCase();
          avatar.style.color = "#fff";
        }

        // Load email and bio from localStorage or Firebase
        emailInput.value =
          localStorage.getItem("bl_profile_email_" + currentUser.username) ||
          "";
        bioInput.value =
          localStorage.getItem("bl_profile_bio_" + currentUser.username) || "";

        // Show level field only for students being viewed by admin
        if (currentUser.role === "admin" && selectedStudent) {
          levelField.style.display = "block";
          levelSelect.value = selectedStudent.level || "A0";
        } else if (currentUser.role === "student") {
          levelField.style.display = "block";
          // Load level from student data
          levelSelect.value = "A0";
          levelSelect.disabled = true;
          db.collection("students")
            .where("name", "==", currentUser.name)
            .get()
            .then(function (snap) {
              if (!snap.empty) {
                var data = snap.docs[0].data();
                levelSelect.value = data.level || "A0";
                emailInput.value = emailInput.value || data.email || "";
                bioInput.value = bioInput.value || data.bio || "";
              }
            });
        } else {
          levelField.style.display = "none";
        }

        // Photo input handler
        document.getElementById("profile-photo-input").onchange = function (e) {
          var file = e.target.files[0];
          if (!file) return;
          // Resize to max 200x200 for localStorage efficiency
          var reader = new FileReader();
          reader.onload = function (ev) {
            var img = new Image();
            img.onload = function () {
              var canvas = document.createElement("canvas");
              var size = Math.min(img.width, img.height, 200);
              canvas.width = size;
              canvas.height = size;
              var ctx = canvas.getContext("2d");
              // Crop to center square
              var sx = (img.width - size) / 2;
              var sy = (img.height - size) / 2;
              ctx.drawImage(img, sx, sy, size, size, 0, 0, size, size);
              profilePhotoData = canvas.toDataURL("image/jpeg", 0.8);
              avatar.style.backgroundImage = "url(" + profilePhotoData + ")";
              avatar.textContent = "";
              avatar.style.color = "transparent";
            };
            img.src = ev.target.result;
          };
          reader.readAsDataURL(file);
        };

        overlay.classList.add("visible");
      }

      function pickProfilePhoto() {
        document.getElementById("profile-photo-input").click();
      }

      function closeProfile() {
        document.getElementById("profile-overlay").classList.remove("visible");
      }

      // Close profile on Escape key
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          var profileOverlay = document.getElementById("profile-overlay");
          if (profileOverlay && profileOverlay.classList.contains("visible")) {
            closeProfile();
          }
        }
      });

      function saveProfile() {
        var newName = document
          .getElementById("profile-display-name")
          .value.trim();
        var email = document.getElementById("profile-email").value.trim();
        var bio = document.getElementById("profile-bio").value.trim();
        var level = document.getElementById("profile-level").value;

        if (!newName) {
          alert("Please enter a display name.");
          return;
        }

        // Update display name
        currentUser.displayName = newName;
        document.getElementById("current-user-name").textContent = newName;
        document.getElementById("welcome-name-display").textContent = newName;

        // Save to localStorage
        localStorage.setItem("bl_header_name_" + currentUser.username, newName);
        localStorage.setItem("bl_profile_email_" + currentUser.username, email);
        localStorage.setItem("bl_profile_bio_" + currentUser.username, bio);

        // Save photo if changed
        if (profilePhotoData) {
          localStorage.setItem(
            "bl_avatar_" + currentUser.name,
            profilePhotoData,
          );
          // Refresh sidebar avatars
          loadAvatarPhotos();
        }

        // Save to Firebase for students
        if (currentUser.role === "student") {
          db.collection("students")
            .where("name", "==", currentUser.name)
            .get()
            .then(function (snap) {
              if (!snap.empty) {
                snap.docs[0].ref.update({
                  displayName: newName,
                  email: email || null,
                  bio: bio || null,
                });
              }
            });
        }

        // If admin and editing a selected student, update level
        if (currentUser.role === "admin" && selectedStudent) {
          db.collection("students")
            .doc(selectedStudent.id)
            .update({
              level: level,
            })
            .then(function () {
              selectedStudent.level = level;
              loadStudents();
            });
        }

        closeProfile();

        // Show a quick toast
        var toast = document.createElement("div");
        toast.textContent = "✅ Profile saved!";
        toast.style.cssText =
          "position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#22c55e;color:#fff;padding:10px 24px;border-radius:8px;font-size:14px;font-weight:600;z-index:3000;animation:fadeInUp 0.3s ease;";
        document.body.appendChild(toast);
        setTimeout(function () {
          toast.remove();
        }, 2000);
      }

      // ========== GAME TEMPLATE SYSTEM ==========
      var GAME_TEMPLATES = [
        {
          title: "🎪 Command Circus",
          url: "games/command-circus/index.html",
          desc: "Learn Portuguese commands with circus performers!",
        },
        {
          title: "🏰 Build Your Castle",
          url: "games/build-your-castle/index.html",
          desc: "Build a castle by learning objects & furniture",
        },
        {
          title: "🌊 Ocean Explorer",
          url: "games/ocean-explorer/index.html",
          desc: "Dive deep and discover animal vocabulary",
        },
        {
          title: "🧑‍🍳 Magic Kitchen",
          url: "games/magic-kitchen/index.html",
          desc: "Cook up food vocabulary in the magic kitchen!",
        },
        {
          title: "🎭 Emotion Island",
          url: "games/emotion-island/index.html",
          desc: "Discover feelings and emotions in Portuguese",
        },
        {
          title: "🚗 Build Your Car",
          url: "games/build-your-car/index.html",
          desc: "Unlock car parts by answering vocab questions",
        },
        {
          title: "🏠 Build Your House",
          url: "games/build-your-house/index.html",
          desc: "Build a house with correct answers",
        },
        {
          title: "🚀 Build Your Rocket",
          url: "games/build-your-rocket/index.html",
          desc: "Launch a rocket by learning vocabulary",
        },
        {
          title: "🤖 Build Your Robot",
          url: "games/build-your-robot/index.html",
          desc: "Assemble a robot with Portuguese words",
        },
        {
          title: "🦕 Build Your Dinosaur",
          url: "games/build-your-dinosaur/index.html",
          desc: "Create a dinosaur through language practice",
        },
      ];

      // Override the add-game-btn to show template picker
      var origGameBtn = document.getElementById("add-game-btn");
      if (origGameBtn) {
        var origHandler = origGameBtn.onclick;
        origGameBtn.onclick = function () {
          if (!selectedStudent) {
            alert("Select a student first");
            return;
          }
          var templatesHtml =
            '<div style="margin-bottom:16px"><h4 style="margin-bottom:12px">Quick Add from Templates</h4>';
          GAME_TEMPLATES.forEach(function (t) {
            templatesHtml +=
              '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)">' +
              '<div><div style="font-weight:500;font-size:14px">' +
              t.title +
              '</div><div style="font-size:12px;color:var(--text-muted)">' +
              t.desc +
              "</div></div>" +
              '<button class="btn-small" onclick="addGameFromTemplate(\'' +
              t.title.replace(/'/g, "\\'") +
              "','" +
              t.url +
              "','" +
              t.desc.replace(/'/g, "\\'") +
              "')\">" +
              SVG.play +
              " Add</button></div>";
          });
          templatesHtml +=
            '</div><hr style="border-color:var(--border);margin:16px 0"><h4 style="margin-bottom:12px">Custom Game</h4>';
          templatesHtml +=
            '<form id="item-form"><div class="form-group"><label>Title</label><input type="text" name="title" required></div>' +
            '<div class="form-group"><label>URL</label><input type="url" name="url" required></div>' +
            '<div class="form-group"><label>Description</label><input type="text" name="description"></div>' +
            '<button type="submit" class="btn">Add Custom Game</button></form>';
          openModal("Add Game", templatesHtml);
          document.getElementById("item-form").onsubmit = function (e) {
            e.preventDefault();
            var form = new FormData(this);
            db.collection("students")
              .doc(selectedStudent.id)
              .collection("games")
              .add({
                title: form.get("title"),
                url: form.get("url"),
                description: form.get("description"),
                createdAt: new Date(),
              })
              .then(function () {
                closeModal();
                loadStudentData();
              });
          };
        };
      }

      function addGameFromTemplate(title, url, desc) {
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("games")
          .add({
            title: title,
            url: url,
            description: desc,
            createdAt: new Date(),
          })
          .then(function () {
            closeModal();
            loadStudentData();
          });
      }

      // ========== NOTES ON ITEMS ==========
      // Add notes button to item cards (intercept loadStudentData)
      var _origLoadStudentData = loadStudentData;
      loadStudentData = function () {
        _origLoadStudentData();
        // Load new tabs too
        loadVocab();
        loadHomework();
        loadClassBook();
        renderPlanner();
        loadProgressCharts();
        // Enable drag reorder after a short delay for DOM to update
        setTimeout(function () {
          enableDragReorder("games-list", "games");
          enableDragReorder("vocab-list", "vocab");
          enableDragReorder("homework-list", "homework");
          // Add draggable attribute to cards
          document
            .querySelectorAll(".item-card, .vocab-card, .homework-card")
            .forEach(function (card) {
              card.setAttribute("draggable", "true");
            });
          // Load avatar photos
          loadAvatarPhotos();
          setupAvatarUpload();
          // Add export buttons to diagnostic cards
          addExportButtons();
          // Add notes to item cards
          addNotesToCards();
        }, 500);
      };

      function addExportButtons() {
        document
          .querySelectorAll("#diagnostics-list .item-card")
          .forEach(function (card) {
            var actions = card.querySelector(".item-actions");
            if (!actions || actions.querySelector(".export-btn")) return;
            var viewBtn = actions.querySelector(
              "button[onclick*='viewDiagnosticResults']",
            );
            if (viewBtn) {
              var diagId = viewBtn.getAttribute("onclick").match(/'([^']+)'/);
              if (diagId && diagId[1]) {
                var btn = document.createElement("button");
                btn.className = "btn-small export-btn";
                btn.innerHTML = SVG.download + " Export";
                btn.onclick = function () {
                  exportDiagnosticPDF(diagId[1]);
                };
                actions.appendChild(btn);
              }
            }
          });
      }

      function addNotesToCards() {
        document
          .querySelectorAll(
            "#games-list .item-card, #tests-list .item-card, #links-list .item-card",
          )
          .forEach(function (card) {
            var actions = card.querySelector(".item-actions");
            if (!actions || actions.querySelector(".note-btn")) return;
            var btn = document.createElement("button");
            btn.className = "btn-small note-btn";
            btn.innerHTML = SVG.chat + " Note";
            btn.onclick = function () {
              var existing = card.querySelector(".item-note");
              if (existing) {
                existing.remove();
                return;
              }
              var noteDiv = document.createElement("div");
              noteDiv.className = "item-note";
              noteDiv.style.cssText =
                "margin-top:8px;padding:8px;background:var(--bg-tertiary);border-radius:var(--radius);";
              noteDiv.innerHTML =
                '<textarea style="width:100%;padding:6px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;font-family:inherit;font-size:12px;color:var(--text-primary);resize:vertical;min-height:40px;outline:none" placeholder="Add a note..."></textarea>';
              card.appendChild(noteDiv);
              noteDiv.querySelector("textarea").focus();
            };
            actions.appendChild(btn);
          });
      }

      // ========== STUDENT SELF-ACCESS PORTAL ==========
      // Students see a simplified, friendly view
      var _origLoginSuccess2 = loginSuccess;
      loginSuccess = function (username, userData) {
        _origLoginSuccess2(username, userData);
        if (userData.role === "student") {
          // Hide add-item buttons for students
          document.querySelectorAll(".add-item-card").forEach(function (el) {
            el.style.display = "none";
          });
        }
      };

      // ========== CLASSES TAB ==========
      var currentClassView = "next";

      function switchClassView(view) {
        currentClassView = view;
        document.querySelectorAll(".classes-subnav-btn").forEach(function (b) {
          b.classList.toggle("active", b.dataset.view === view);
        });
        loadClasses();
      }

      function loadClasses() {
        if (!selectedStudent) return;
        var content = document.getElementById("classes-content");
        var isAdmin = currentUser && currentUser.role === "admin";
        var addRow = document.getElementById("classes-add-row");
        if (addRow) addRow.style.display = isAdmin ? "" : "none";

        content.innerHTML = '<div class="empty-state">Loading...</div>';

        db.collection("students")
          .doc(selectedStudent.id)
          .collection("classes")
          .orderBy("date", "asc")
          .get()
          .then(function (snap) {
            if (snap.empty) {
              content.innerHTML =
                '<div class="classes-empty"><div class="classes-empty-emoji">📅</div><div class="classes-empty-text">No classes scheduled yet</div></div>';
              return;
            }

            var now = new Date();
            var todayStr = now.toISOString().split("T")[0];
            var allClasses = [];
            snap.forEach(function (doc) {
              var d = doc.data();
              d._id = doc.id;
              allClasses.push(d);
            });

            // Categorize
            var past = [],
              upcoming = [];
            allClasses.forEach(function (c) {
              if (c.date < todayStr) {
                past.push(c);
              } else {
                upcoming.push(c);
              }
            });

            // Today's classes go into upcoming
            var todayClasses = allClasses.filter(function (c) {
              return c.date === todayStr;
            });

            // Sort past descending (most recent first)
            past.sort(function (a, b) {
              return b.date.localeCompare(a.date);
            });
            // upcoming is already ascending

            var nextClass = upcoming.length > 0 ? upcoming[0] : null;
            var futureClasses = upcoming.length > 1 ? upcoming.slice(1) : [];

            content.innerHTML = "";

            if (currentClassView === "next") {
              renderNextClassView(content, nextClass, isAdmin);
            } else if (currentClassView === "previous") {
              renderClassList(content, past, "past", isAdmin);
            } else if (currentClassView === "future") {
              renderClassList(content, futureClasses, "future", isAdmin);
            }
          })
          .catch(function (e) {
            content.innerHTML =
              '<div class="empty-state">Error loading classes: ' +
              e.message +
              "</div>";
          });
      }

      function renderNextClassView(container, nextClass, isAdmin) {
        if (!nextClass) {
          container.innerHTML =
            '<div class="classes-empty"><div class="classes-empty-emoji">🎓</div><div class="classes-empty-text">No upcoming class scheduled!</div></div>';
          return;
        }

        var dateObj = new Date(nextClass.date + "T00:00:00");
        var dayNames = [
          "Domingo",
          "Segunda",
          "Terça",
          "Quarta",
          "Quinta",
          "Sexta",
          "Sábado",
        ];
        var monthNames = [
          "Jan",
          "Fev",
          "Mar",
          "Abr",
          "Mai",
          "Jun",
          "Jul",
          "Ago",
          "Set",
          "Out",
          "Nov",
          "Dez",
        ];
        var dayName = dayNames[dateObj.getDay()];
        var dayNum = dateObj.getDate();
        var monthName = monthNames[dateObj.getMonth()];

        // Countdown
        var now = new Date();
        var diff = dateObj - now;
        var daysUntil = Math.ceil(diff / (1000 * 60 * 60 * 24));
        var countdownText = "";
        if (daysUntil <= 0) {
          countdownText = "📍 Today!";
        } else if (daysUntil === 1) {
          countdownText = "⏰ Tomorrow!";
        } else {
          countdownText = "📆 In " + daysUntil + " days";
        }

        var html = '<div class="class-next-hero">';
        html += '<div class="hero-emoji">📚</div>';
        html +=
          '<div class="hero-date">' +
          dayName +
          ", " +
          dayNum +
          " " +
          monthName +
          "</div>";
        if (nextClass.time)
          html += '<div class="hero-time">🕐 ' + nextClass.time + "</div>";
        html += '<div class="hero-countdown">' + countdownText + "</div>";

        // Details
        if (
          nextClass.topics ||
          nextClass.objectives ||
          nextClass.materials ||
          nextClass.notes
        ) {
          html += '<div class="class-next-details">';
          if (nextClass.topics) {
            html +=
              '<div class="class-card-field"><span class="class-card-field-icon">📝</span><div><strong>Topics:</strong> <div class="class-card-tags">';
            nextClass.topics.split(",").forEach(function (t) {
              html += '<span class="class-card-tag">' + t.trim() + "</span>";
            });
            html += "</div></div></div>";
          }
          if (nextClass.objectives) {
            html +=
              '<div class="class-card-field"><span class="class-card-field-icon">🎯</span><div><strong>Objectives:</strong> ' +
              nextClass.objectives +
              "</div></div>";
          }
          if (nextClass.materials) {
            html +=
              '<div class="class-card-field"><span class="class-card-field-icon">📦</span><div><strong>Materials:</strong> ' +
              nextClass.materials +
              "</div></div>";
          }
          if (nextClass.notes) {
            html +=
              '<div class="class-card-field"><span class="class-card-field-icon">💡</span><div><strong>Notes:</strong> ' +
              nextClass.notes +
              "</div></div>";
          }
          html += "</div>";
        }

        if (isAdmin) {
          html +=
            '<div style="margin-top: 12px; display: flex; gap: 8px; justify-content: center">';
          html +=
            '<button class="btn-small" onclick="editClass(\'' +
            nextClass._id +
            "')\">✏️ Edit</button>";
          html +=
            '<button class="btn-small" onclick="deleteClass(\'' +
            nextClass._id +
            '\')" style="color: var(--red)">🗑 Delete</button>';
          html += "</div>";
        }

        html += "</div>";
        container.innerHTML = html;
      }

      function renderClassList(container, classes, type, isAdmin) {
        if (classes.length === 0) {
          var emptyEmoji = type === "past" ? "📋" : "📅";
          var emptyText =
            type === "past"
              ? "No previous classes yet"
              : "No future classes scheduled";
          container.innerHTML =
            '<div class="classes-empty"><div class="classes-empty-emoji">' +
            emptyEmoji +
            '</div><div class="classes-empty-text">' +
            emptyText +
            "</div></div>";
          return;
        }

        classes.forEach(function (c) {
          var dateObj = new Date(c.date + "T00:00:00");
          var dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
          var dayName = dayNames[dateObj.getDay()];
          var dateDisplay = c.date;

          var card = document.createElement("div");
          card.className = "class-card";

          var badgeClass = type === "past" ? "past" : "future";
          var badgeText = type === "past" ? "Completed" : "Upcoming";

          var html = '<div class="class-card-header">';
          html +=
            '<div class="class-card-date">' +
            SVG.calendar +
            " " +
            dayName +
            " " +
            dateDisplay;
          if (c.time) html += " <small>🕐 " + c.time + "</small>";
          html += "</div>";
          html +=
            '<span class="class-card-badge ' +
            badgeClass +
            '">' +
            badgeText +
            "</span>";
          html += "</div>";
          html += '<div class="class-card-body">';

          if (c.topics) {
            html +=
              '<div class="class-card-field"><span class="class-card-field-icon">📝</span><div><strong>Topics:</strong> <div class="class-card-tags">';
            c.topics.split(",").forEach(function (t) {
              html += '<span class="class-card-tag">' + t.trim() + "</span>";
            });
            html += "</div></div></div>";
          }
          if (c.objectives) {
            html +=
              '<div class="class-card-field"><span class="class-card-field-icon">🎯</span><div><strong>Objectives:</strong> ' +
              c.objectives +
              "</div></div>";
          }
          if (c.materials) {
            html +=
              '<div class="class-card-field"><span class="class-card-field-icon">📦</span><div><strong>Materials:</strong> ' +
              c.materials +
              "</div></div>";
          }
          if (c.notes) {
            html +=
              '<div class="class-card-field"><span class="class-card-field-icon">💡</span><div><strong>Notes:</strong> ' +
              c.notes +
              "</div></div>";
          }
          if (type === "past" && c.summary) {
            html +=
              '<div class="class-card-field"><span class="class-card-field-icon">📖</span><div><strong>Summary:</strong> ' +
              c.summary +
              "</div></div>";
          }

          html += "</div>";

          if (isAdmin) {
            html += '<div class="class-card-actions">';
            html +=
              '<button class="btn-small" onclick="editClass(\'' +
              c._id +
              "')\">✏️ Edit</button>";
            html +=
              '<button class="btn-small" onclick="deleteClass(\'' +
              c._id +
              '\')" style="color: var(--red)">🗑 Delete</button>';
            html += "</div>";
          }

          card.innerHTML = html;
          container.appendChild(card);
        });
      }

      function openAddClass() {
        if (!selectedStudent) {
          alert("Select a student first");
          return;
        }
        var today = new Date().toISOString().split("T")[0];
        openModal(
          "Schedule a Class",
          '<form id="class-form">' +
            '<div class="form-group"><label>Date</label><input type="date" name="date" value="' +
            today +
            '" required></div>' +
            '<div class="form-group"><label>Time</label><input type="time" name="time"></div>' +
            '<div class="form-group"><label>Topics (comma-separated)</label><input type="text" name="topics" placeholder="e.g. Colors, Numbers, Greetings"></div>' +
            '<div class="form-group"><label>Objectives</label><textarea name="objectives" rows="2" placeholder="What will the student learn?"></textarea></div>' +
            '<div class="form-group"><label>Materials needed</label><input type="text" name="materials" placeholder="e.g. Flashcards, worksheets"></div>' +
            '<div class="form-group"><label>Notes</label><textarea name="notes" rows="2" placeholder="Any preparation notes..."></textarea></div>' +
            '<button type="submit" class="btn">Schedule Class</button></form>',
        );

        document.getElementById("class-form").onsubmit = function (e) {
          e.preventDefault();
          var form = new FormData(this);
          db.collection("students")
            .doc(selectedStudent.id)
            .collection("classes")
            .add({
              date: form.get("date"),
              time: form.get("time") || "",
              topics: form.get("topics") || "",
              objectives: form.get("objectives") || "",
              materials: form.get("materials") || "",
              notes: form.get("notes") || "",
              summary: "",
              createdAt: new Date(),
            })
            .then(function () {
              closeModal();
              loadClasses();
            });
        };
      }

      function editClass(classId) {
        if (!selectedStudent) return;
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("classes")
          .doc(classId)
          .get()
          .then(function (doc) {
            if (!doc.exists) return;
            var c = doc.data();
            openModal(
              "Edit Class",
              '<form id="class-edit-form">' +
                '<div class="form-group"><label>Date</label><input type="date" name="date" value="' +
                (c.date || "") +
                '" required></div>' +
                '<div class="form-group"><label>Time</label><input type="time" name="time" value="' +
                (c.time || "") +
                '"></div>' +
                '<div class="form-group"><label>Topics (comma-separated)</label><input type="text" name="topics" value="' +
                (c.topics || "") +
                '"></div>' +
                '<div class="form-group"><label>Objectives</label><textarea name="objectives" rows="2">' +
                (c.objectives || "") +
                "</textarea></div>" +
                '<div class="form-group"><label>Materials</label><input type="text" name="materials" value="' +
                (c.materials || "") +
                '"></div>' +
                '<div class="form-group"><label>Notes</label><textarea name="notes" rows="2">' +
                (c.notes || "") +
                "</textarea></div>" +
                '<div class="form-group"><label>Class Summary (after class)</label><textarea name="summary" rows="2" placeholder="How did the class go?">' +
                (c.summary || "") +
                "</textarea></div>" +
                '<button type="submit" class="btn">Save Changes</button></form>',
            );

            document.getElementById("class-edit-form").onsubmit = function (e) {
              e.preventDefault();
              var form = new FormData(this);
              db.collection("students")
                .doc(selectedStudent.id)
                .collection("classes")
                .doc(classId)
                .update({
                  date: form.get("date"),
                  time: form.get("time") || "",
                  topics: form.get("topics") || "",
                  objectives: form.get("objectives") || "",
                  materials: form.get("materials") || "",
                  notes: form.get("notes") || "",
                  summary: form.get("summary") || "",
                })
                .then(function () {
                  closeModal();
                  loadClasses();
                });
            };
          });
      }

      function deleteClass(classId) {
        if (!confirm("Delete this class?")) return;
        db.collection("students")
          .doc(selectedStudent.id)
          .collection("classes")
          .doc(classId)
          .delete()
          .then(function () {
            loadClasses();
          });
      }

      // ========== TAB VISIBILITY PER STUDENT ==========
      var ALL_TABS = [
        "diagnostics",
        "games",
        "tests",
        "links",
        "progress",
        "classlog",
        "vocab",
        "homework",
        "planner",
        "classbook",
        "classes",
      ];

      function getHiddenTabs(studentName) {
        var stored = localStorage.getItem("bl_hidden_tabs_" + studentName);
        return stored ? JSON.parse(stored) : [];
      }

      function setHiddenTabs(studentName, hiddenTabs) {
        localStorage.setItem(
          "bl_hidden_tabs_" + studentName,
          JSON.stringify(hiddenTabs),
        );
      }

      var currentTabFilter = "all";

      function applyTabVisibility(studentName) {
        var hidden = getHiddenTabs(studentName);
        var isAdmin = currentUser && currentUser.role === "admin";
        var navTabs = document.querySelectorAll("#student-nav .nav-tab");

        navTabs.forEach(function (tab) {
          var tabName = tab.dataset.tab;
          var isHidden = hidden.indexOf(tabName) !== -1;
          var eyeBtn = tab.querySelector(".tab-eye-btn");

          if (isAdmin) {
            // Admin sees all tabs, hidden ones are dimmed
            tab.classList.toggle("tab-is-hidden", isHidden);

            // Apply filter
            if (currentTabFilter === "visible") {
              tab.style.display = isHidden ? "none" : "";
            } else if (currentTabFilter === "hidden") {
              tab.style.display = isHidden ? "" : "none";
            } else {
              tab.style.display = "";
            }

            // Update eye icon
            if (eyeBtn) {
              eyeBtn.classList.toggle("tab-hidden", isHidden);
              eyeBtn.title = isHidden ? "Show to student" : "Hide from student";
              eyeBtn.innerHTML = isHidden
                ? '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M3.53 2.47a.75.75 0 0 0-1.06 1.06l18 18a.75.75 0 1 0 1.06-1.06l-18-18ZM22.676 12.553a11.249 11.249 0 0 1-2.631 4.31l-3.099-3.099a5.25 5.25 0 0 0-6.71-6.71L7.759 4.577A11.217 11.217 0 0 1 12 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113Z"/><path d="M15.75 12c0 .18-.013.357-.037.53l-4.244-4.243A3.75 3.75 0 0 1 15.75 12ZM12.53 15.713l-4.243-4.244a3.75 3.75 0 0 0 4.244 4.243Z"/><path d="M6.75 12c0-.619.107-1.213.304-1.764l-3.1-3.1a11.25 11.25 0 0 0-2.63 4.31c-.12.362-.12.752 0 1.114 1.489 4.467 5.704 7.69 10.675 7.69 1.5 0 2.933-.294 4.242-.827l-2.477-2.477A5.25 5.25 0 0 1 6.75 12Z"/></svg>'
                : '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path fill-rule="evenodd" d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.224-10.676-7.69a1.762 1.762 0 0 1 0-1.113ZM17.25 12a5.25 5.25 0 1 1-10.5 0 5.25 5.25 0 0 1 10.5 0Z" clip-rule="evenodd"/></svg>';
            }
          } else {
            // Student: hidden tabs are completely invisible
            tab.style.display = isHidden ? "none" : "";
            tab.classList.remove("tab-is-hidden");
            if (eyeBtn) eyeBtn.style.display = "none";
          }
        });

        // If the currently active tab is hidden for a student, switch to first visible
        if (!isAdmin) {
          var activeTab = document.querySelector(
            "#student-nav .nav-tab.active",
          );
          if (activeTab && activeTab.style.display === "none") {
            var firstVisible = document.querySelector(
              '#student-nav .nav-tab:not([style*="display: none"])',
            );
            if (firstVisible) {
              document.querySelectorAll(".nav-tab").forEach(function (t) {
                t.classList.remove("active");
              });
              firstVisible.classList.add("active");
              showPanel(firstVisible.dataset.tab);
            }
          }
        }
      }

      function toggleTabEye(tabName) {
        if (!selectedStudent) return;
        var hidden = getHiddenTabs(selectedStudent.name);
        var idx = hidden.indexOf(tabName);
        if (idx !== -1) {
          hidden.splice(idx, 1);
        } else {
          hidden.push(tabName);
        }
        setHiddenTabs(selectedStudent.name, hidden);
        applyTabVisibility(selectedStudent.name);
      }

      function filterAdminTabs(filter) {
        currentTabFilter = filter;
        document.querySelectorAll(".tab-filter-btn").forEach(function (btn) {
          btn.classList.toggle("active", btn.dataset.filter === filter);
        });
        if (selectedStudent) {
          applyTabVisibility(selectedStudent.name);
        }
      }
    </script>
  </body>
</html>
